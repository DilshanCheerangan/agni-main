<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AGNI – Intelligent Agriculture Platform</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,400;0,9..40,600;0,9..40,700;1,9..40,400&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" crossorigin />
  <style>
    :root {
      --glass-bg: rgba(255, 255, 255, 0.72);
      --glass-border: rgba(255, 255, 255, 0.35);
      --glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
      --accent: #059669;
      --accent-light: rgba(5, 150, 105, 0.12);
    }

    body {
      font-family: 'DM Sans', system-ui, sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* App background: soft gradient + subtle mesh feel */
    .app-bg {
      background: linear-gradient(160deg, #f0fdf4 0%, #ecfdf5 25%, #d1fae5 50%, #ccfbf1 75%, #f0fdfa 100%);
      background-attachment: fixed;
      min-height: 100vh;
    }

    /* Login screen: immersive gradient */
    .login-bg {
      background: linear-gradient(135deg, #064e3b 0%, #065f46 30%, #047857 60%, #059669 100%);
      background-attachment: fixed;
      min-height: 100vh;
      position: relative;
      overflow: hidden;
    }
    .login-bg::before {
      content: '';
      position: absolute;
      inset: 0;
      background: radial-gradient(ellipse 80% 50% at 50% -20%, rgba(255,255,255,0.15), transparent),
                  radial-gradient(ellipse 60% 40% at 100% 100%, rgba(255,255,255,0.08), transparent);
      pointer-events: none;
    }

    /* Glass panels */
    .glass {
      background: var(--glass-bg);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid var(--glass-border);
      box-shadow: var(--glass-shadow);
    }
    .glass-dark {
      background: rgba(15, 23, 42, 0.65);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
    }
    .glass-card {
      background: rgba(255, 255, 255, 0.75);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border: 1px solid rgba(255, 255, 255, 0.6);
      box-shadow: 0 4px 24px rgba(0, 0, 0, 0.06), 0 0 0 1px rgba(255,255,255,0.5) inset;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .glass-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 32px rgba(0, 0, 0, 0.08), 0 0 0 1px rgba(255,255,255,0.6) inset;
    }
    .glass-nav-item {
      transition: all 0.2s ease;
    }
    .glass-nav-item:hover {
      background: rgba(255, 255, 255, 0.6);
      backdrop-filter: blur(8px);
    }
    .glass-nav-item.active {
      background: rgba(5, 150, 105, 0.15);
      color: #047857;
      font-weight: 600;
      border-left: 3px solid var(--accent);
    }

    .sidebar-transition { transition: transform 0.3s ease-in-out; }
    .page-transition { transition: opacity 0.2s ease-in-out; }

    .gradient-bg {
      background: linear-gradient(135deg, #10b981 0%, #059669 50%, #0d9488 100%);
      box-shadow: 0 4px 14px rgba(5, 150, 105, 0.35);
    }

    #farmMap {
      height: 320px;
      width: 100%;
      border-radius: 0.75rem;
      border: 1px solid rgba(255,255,255,0.5);
      box-shadow: 0 4px 20px rgba(0,0,0,0.06);
    }

    .leaflet-draw-toolbar a { background-color: #059669 !important; }
    .location-method-btn.active {
      border-color: #059669 !important;
      background-color: rgba(5, 150, 105, 0.15) !important;
      color: #047857 !important;
    }
    .location-pin { background: none !important; border: none !important; }
    .analysis-panel-caption {
      min-height: 3rem;
      display: flex;
      flex-direction: column;
      justify-content: flex-end;
    }
    .landuse-bar-fill { flex-shrink: 0; }

    /* Buttons: subtle glass / lift */
    .btn-glass {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(8px);
      border: 1px solid rgba(255,255,255,0.8);
      box-shadow: 0 2px 12px rgba(0,0,0,0.06);
      transition: all 0.2s ease;
    }
    .btn-glass:hover {
      background: rgba(255, 255, 255, 1);
      transform: translateY(-1px);
      box-shadow: 0 4px 16px rgba(0,0,0,0.08);
    }
    .btn-primary {
      background: linear-gradient(135deg, #059669 0%, #047857 100%);
      box-shadow: 0 4px 14px rgba(5, 150, 105, 0.4);
      transition: all 0.2s ease;
    }
    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 20px rgba(5, 150, 105, 0.45);
    }

    /* Inputs: light glass */
    .input-glass {
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(6px);
      border: 1px solid rgba(226, 232, 240, 0.9);
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    .input-glass:focus {
      border-color: rgba(5, 150, 105, 0.5);
      box-shadow: 0 0 0 3px rgba(5, 150, 105, 0.15);
      outline: none;
    }

    /* Status badge glass */
    .badge-glass {
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(5, 150, 105, 0.25);
      box-shadow: 0 2px 10px rgba(0,0,0,0.04);
    }

    /* Judge card: glass over gradient */
    .judge-card {
      background: linear-gradient(135deg, rgba(5, 150, 105, 0.9) 0%, rgba(13, 148, 136, 0.9) 100%);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255,255,255,0.25);
      box-shadow: 0 8px 32px rgba(5, 150, 105, 0.3);
    }
  </style>
</head>

<body class="min-h-screen">

  <!-- Login Screen -->
  <div id="loginScreen" class="login-bg min-h-screen flex items-center justify-center px-4 relative z-0">
    <div class="w-full max-w-md relative z-10">
      <div class="text-center mb-8">
        <div class="inline-block p-5 rounded-2xl gradient-bg mb-4 shadow-lg">
          <i class="fas fa-seedling text-white text-5xl"></i>
        </div>
        <h1 class="text-4xl font-bold text-white mb-2 drop-shadow-sm">AGNI</h1>
        <p class="text-emerald-100 text-sm">Adaptive Geo-secured Network for Intelligent Agriculture</p>
      </div>
      <div class="glass rounded-2xl shadow-2xl p-8 border border-white/30">
        <h2 class="text-2xl font-semibold text-slate-800 mb-6">Welcome Back</h2>
        <form id="loginForm" class="space-y-5">
          <div>
            <label for="username" class="block text-sm font-medium text-slate-700 mb-2">
              <i class="fas fa-user mr-2 text-emerald-600"></i>Username
            </label>
            <input type="text" id="username" name="username" required
              class="input-glass w-full px-4 py-3 rounded-xl placeholder-slate-400"
              placeholder="Enter your username" />
          </div>
          <div>
            <label for="password" class="block text-sm font-medium text-slate-700 mb-2">
              <i class="fas fa-lock mr-2 text-emerald-600"></i>Password
            </label>
            <input type="password" id="password" name="password" required
              class="input-glass w-full px-4 py-3 rounded-xl placeholder-slate-400"
              placeholder="Enter your password" />
          </div>
          <p id="loginError" class="text-sm text-red-600 hidden"></p>
          <button type="submit"
            class="btn-primary w-full py-3 text-white font-semibold rounded-xl focus:ring-2 focus:ring-emerald-400 focus:ring-offset-2">
            <i class="fas fa-sign-in-alt mr-2"></i>Sign In
          </button>
        </form>
      </div>
    </div>
  </div>

  <!-- Main App Layout -->
  <div id="appLayout" class="app-bg hidden min-h-screen flex">
    <!-- Sidebar -->
    <aside id="sidebar" class="glass w-64 border-r border-white/30 flex flex-col sidebar-transition shadow-xl">
      <div class="p-6 border-b border-white/30">
        <div class="flex items-center gap-3 mb-2">
          <div class="p-2 rounded-lg gradient-bg">
            <i class="fas fa-seedling text-white"></i>
          </div>
          <div>
            <h1 class="text-xl font-bold text-emerald-800">AGNI</h1>
            <p class="text-xs text-slate-500">Agriculture Platform</p>
          </div>
        </div>
        <div class="mt-4 text-sm text-slate-600">
          <i class="fas fa-user-circle mr-2 text-emerald-600"></i>
          <span id="sidebarUsername">User</span>
        </div>
      </div>

      <nav class="flex-1 p-4 space-y-1 overflow-y-auto">
        <a href="#" data-page="dashboard"
          class="nav-item glass-nav-item flex items-center gap-3 px-4 py-3 rounded-xl text-slate-700 active">
          <i class="fas fa-home w-5"></i>
          <span>Dashboard</span>
        </a>
        <a href="#" data-page="analyzer"
          class="nav-item glass-nav-item flex items-center gap-3 px-4 py-3 rounded-xl text-slate-700">
          <i class="fas fa-image w-5"></i>
          <span>Image Analyzer</span>
        </a>
        <a href="#" data-page="ai-suggestion"
          class="nav-item glass-nav-item flex items-center gap-3 px-4 py-3 rounded-xl text-slate-700">
          <i class="fas fa-lightbulb w-5"></i>
          <span>AI Suggestion</span>
        </a>
        <a href="#" data-page="weather"
          class="nav-item glass-nav-item flex items-center gap-3 px-4 py-3 rounded-xl text-slate-700">
          <i class="fas fa-cloud-sun w-5"></i>
          <span>Weather & Climate</span>
        </a>
        <a href="#" data-page="my-lands"
          class="nav-item glass-nav-item flex items-center gap-3 px-4 py-3 rounded-xl text-slate-700">
          <i class="fas fa-map-marked-alt w-5"></i>
          <span>My Lands</span>
        </a>
        <a href="#" data-page="news"
          class="nav-item glass-nav-item flex items-center gap-3 px-4 py-3 rounded-xl text-slate-700">
          <i class="fas fa-newspaper w-5"></i>
          <span>Agricultural News</span>
        </a>
        <a href="#" data-page="profile"
          class="nav-item glass-nav-item flex items-center gap-3 px-4 py-3 rounded-xl text-slate-700">
          <i class="fas fa-user w-5"></i>
          <span>Profile</span>
        </a>
        <a href="#" data-page="settings"
          class="nav-item glass-nav-item flex items-center gap-3 px-4 py-3 rounded-xl text-slate-700">
          <i class="fas fa-cog w-5"></i>
          <span>Settings</span>
        </a>
      </nav>

      <div class="p-4 border-t border-white/30">
        <button id="logoutBtn"
          class="w-full flex items-center gap-3 px-4 py-3 rounded-lg text-red-600 hover:bg-red-50 transition">
          <i class="fas fa-sign-out-alt"></i>
          <span>Logout</span>
        </button>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto">
      <!-- Top Bar -->
      <header class="glass border-b border-white/30 px-6 py-4 shadow-lg">
        <div class="flex items-center justify-between">
          <div>
            <h2 id="pageTitle" class="text-2xl font-bold text-slate-800">Dashboard</h2>
            <p id="pageSubtitle" class="text-sm text-slate-500">Welcome back! Here's your overview</p>
          </div>
          <div class="flex items-center gap-4">
            <div id="statusBadge"
              class="badge-glass flex items-center gap-2 px-4 py-2 rounded-xl">
              <span class="h-2 w-2 rounded-full bg-emerald-500 animate-pulse"></span>
              <span id="statusText" class="text-sm text-emerald-800 font-medium">System Active</span>
            </div>
          </div>
        </div>
      </header>

      <!-- Page Content -->
      <div class="p-6">
        <!-- Dashboard Page -->
        <div id="page-dashboard" class="page-content">
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
            <div class="glass-card rounded-2xl p-6">
              <div class="flex items-center justify-between mb-4">
                <div class="p-3 rounded-lg bg-emerald-100">
                  <i class="fas fa-chart-line text-emerald-600 text-xl"></i>
                </div>
                <span class="text-xs text-slate-500">Total Analyses</span>
              </div>
              <h3 class="text-3xl font-bold text-slate-800 mb-1" id="totalAnalyses">0</h3>
              <p class="text-sm text-slate-600">Field analyses completed</p>
            </div>

            <div class="glass-card rounded-2xl p-6">
              <div class="flex items-center justify-between mb-4">
                <div class="p-3 rounded-lg bg-blue-100">
                  <i class="fas fa-percentage text-blue-600 text-xl"></i>
                </div>
                <span class="text-xs text-slate-500">Avg. Cultivation</span>
              </div>
              <h3 class="text-3xl font-bold text-slate-800 mb-1" id="avgCultivation">—</h3>
              <p class="text-sm text-slate-600">Average cultivated area</p>
            </div>

            <div class="glass-card rounded-2xl p-6">
              <div class="flex items-center justify-between mb-4">
                <div class="p-3 rounded-lg bg-amber-100">
                  <i class="fas fa-shield-alt text-amber-600 text-xl"></i>
                </div>
                <span class="text-xs text-slate-500">Avg. Confidence</span>
              </div>
              <h3 class="text-3xl font-bold text-slate-800 mb-1" id="avgConfidence">—</h3>
              <p class="text-sm text-slate-600">Average confidence score</p>
            </div>
          </div>

          <!-- Judge / pitch summary (one-line takeaway) -->
          <div id="judgeSummaryCard" class="judge-card hidden mb-6 rounded-2xl shadow-xl p-6 text-white border border-white/20">
            <h3 class="text-lg font-semibold mb-2 flex items-center gap-2">
              <i class="fas fa-trophy"></i>
              Your latest plot at a glance
            </h3>
            <p id="judgeSummaryText" class="text-xl font-medium mb-1">—</p>
            <p id="judgeSummarySub" class="text-emerald-100 text-sm">Run an analysis and get a suggestion to see your one-line summary here.</p>
          </div>

          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="glass-card rounded-2xl p-6">
              <h3 class="text-lg font-semibold text-slate-800 mb-4 flex items-center gap-2">
                <i class="fas fa-history text-emerald-600"></i>
                Recent Analyses
              </h3>
              <div id="historyList" class="space-y-3">
                <p class="text-slate-400 text-sm">No analyses yet.</p>
              </div>
            </div>

            <div class="glass-card rounded-2xl p-6">
              <h3 class="text-lg font-semibold text-slate-800 mb-4 flex items-center gap-2">
                <i class="fas fa-info-circle text-blue-600"></i>
                Quick Tips
              </h3>
              <div class="space-y-3 text-sm text-slate-600">
                <div class="flex items-start gap-3">
                  <i class="fas fa-check-circle text-emerald-500 mt-0.5"></i>
                  <p>Upload clear, daylight images for best results</p>
                </div>
                <div class="flex items-start gap-3">
                  <i class="fas fa-check-circle text-emerald-500 mt-0.5"></i>
                  <p>Check weather conditions before field work</p>
                </div>
                <div class="flex items-start gap-3">
                  <i class="fas fa-check-circle text-emerald-500 mt-0.5"></i>
                  <p>Review agricultural news for latest trends</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Image Analyzer Page -->
        <div id="page-analyzer" class="page-content hidden">
          <!-- Location Selection Method -->
          <div class="glass-card rounded-2xl p-6 mb-6">
            <h3 class="text-lg font-semibold text-slate-800 mb-4 flex items-center gap-2">
              <i class="fas fa-map-marked-alt text-emerald-600"></i>
              Select Farm Location
            </h3>
            <div class="flex flex-wrap items-center gap-4 mb-4">
              <div class="flex gap-4">
                <button type="button" id="locationMethodMap" class="location-method-btn px-4 py-2 rounded-lg border-2 border-emerald-600 bg-emerald-50 text-emerald-700 font-medium transition">
                  <i class="fas fa-map mr-2"></i>Map Selection
                </button>
                <button type="button" id="locationMethodPincode" class="location-method-btn px-4 py-2 rounded-lg border-2 border-slate-300 bg-white text-slate-700 font-medium transition">
                  <i class="fas fa-map-pin mr-2"></i>Pincode / Place
                </button>
              </div>
              <div class="flex items-center gap-2 border-l border-slate-200 pl-4">
                <span class="text-sm text-slate-600">Load saved place:</span>
                <select id="loadSavedPlaceSelect" class="text-sm border border-slate-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-emerald-500 max-w-[200px]">
                  <option value="">— Choose one —</option>
                </select>
                <button type="button" id="loadSavedPlaceBtn" class="px-3 py-2 bg-slate-100 text-slate-700 rounded-lg hover:bg-slate-200 transition text-sm font-medium disabled:opacity-50" disabled>
                  <i class="fas fa-map-marker-alt mr-1"></i>Load
                </button>
              </div>
            </div>
            
            <!-- Map Selection Method -->
            <div id="locationMethodMapPanel" class="location-panel">
              <p class="text-sm text-slate-600 mb-2">Draw a polygon on the map to define your farm area. Use the layer
                control (top-right) to switch to <strong>Satellite</strong> view for easier selection.</p>
              <p class="text-xs text-slate-500 mb-4">Step 1: Draw polygon (click corners, double-click to finish) → Step
                2: Click &quot;Confirm Farm Boundary&quot; → Step 3: Upload image below and click Analyze.</p>
              <div id="farmMap"></div>
              <div class="mt-4 flex flex-wrap items-center gap-3">
                <button type="button" id="confirmBoundaryBtn"
                  class="px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition font-medium disabled:opacity-50 disabled:cursor-not-allowed"
                  disabled>
                  <i class="fas fa-check mr-2"></i>Confirm Farm Boundary
                </button>
                <button type="button" id="savePlaceBtn"
                  class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-medium disabled:opacity-50 disabled:cursor-not-allowed"
                  disabled title="Save this place so you don't need to select the map every time">
                  <i class="fas fa-save mr-2"></i>Save this place
                </button>
                <button type="button" id="clearBoundaryBtn"
                  class="px-4 py-2 bg-slate-200 text-slate-700 rounded-lg hover:bg-slate-300 transition font-medium hidden">
                  <i class="fas fa-eraser mr-2"></i>Clear Boundary
                </button>
                <span id="boundarySummary" class="text-sm text-slate-500"></span>
              </div>
              <p id="boundaryError" class="text-sm text-red-600 mt-2 hidden"></p>
            </div>
            
            <!-- Pincode/Place Selection Method -->
            <div id="locationMethodPincodePanel" class="location-panel hidden">
              <p class="text-sm text-slate-600 mb-4">Enter pincode or place name. The map will show that location so you can then draw your farm boundary on the map.</p>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-slate-700 mb-2">
                    <i class="fas fa-map-pin mr-2 text-emerald-600"></i>Pincode
                  </label>
                  <input type="text" id="farmPincode" placeholder="e.g., 110001"
                    class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500" />
                </div>
                <div>
                  <label class="block text-sm font-medium text-slate-700 mb-2">
                    <i class="fas fa-city mr-2 text-emerald-600"></i>Place Name
                  </label>
                  <input type="text" id="farmPlace" placeholder="e.g., Delhi, New Delhi"
                    class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500" />
                </div>
              </div>
              <div class="mt-4 flex flex-wrap items-center gap-3">
                <button type="button" id="confirmLocationBtn"
                  class="px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition font-medium">
                  <i class="fas fa-check mr-2"></i>Show on Map
                </button>
                <button type="button" id="useCurrentLocationBtn"
                  class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-medium">
                  <i class="fas fa-crosshairs mr-2"></i>Use Current Location
                </button>
                <span id="locationSummary" class="text-sm text-slate-500"></span>
              </div>
              <p id="locationError" class="text-sm text-red-600 mt-2 hidden"></p>
              <p id="locationMapHint" class="text-sm text-emerald-700 mt-2 hidden">
                <i class="fas fa-map mr-1"></i>Map below is centered on your location. Switch to &quot;Map Selection&quot; to draw your farm boundary.
              </p>
            </div>
          </div>

          <!-- Use map as image -->
          <div class="bg-emerald-50 rounded-xl shadow-md border border-emerald-200 p-6 mb-6">
            <h3 class="text-lg font-semibold text-emerald-800 mb-2 flex items-center gap-2">
              <i class="fas fa-map-pin text-emerald-600"></i>
              Use map as image
            </h3>
            <p class="text-sm text-emerald-700 mb-4">Capture the current map view (including satellite) as the image to
              analyze. Your drawn boundary will be used so the analysis matches exactly what you see.</p>
            <div class="flex flex-wrap items-center gap-3">
              <button type="button" id="captureMapBtn"
                class="px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition font-medium disabled:opacity-50 disabled:cursor-not-allowed">
                <i class="fas fa-camera mr-2"></i>Capture map for analysis
              </button>
              <button type="button" id="clearMapCaptureBtn"
                class="hidden px-4 py-2 bg-slate-200 text-slate-700 rounded-lg hover:bg-slate-300 transition font-medium">
                <i class="fas fa-times mr-2"></i>Clear and use file instead
              </button>
              <span id="mapCaptureStatus" class="text-sm text-emerald-700"></span>
            </div>
            <p id="mapCaptureError" class="text-sm text-red-600 mt-2 hidden"></p>
            <div id="mapCapturePreview" class="mt-3 hidden">
              <p class="text-xs text-slate-500 mb-1">Preview (boundary area only — this will be sent for analysis):</p>
              <img id="mapCapturePreviewImg" alt="Map capture" class="max-h-32 rounded border border-slate-300" />
              <button type="button" id="analyzeMapCaptureBtn"
                class="mt-3 px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition font-medium inline-flex items-center gap-2">
                <i class="fas fa-chart-line"></i>Analyze this image
              </button>
            </div>
          </div>

          <div class="glass-card rounded-2xl p-6 mb-6">
            <h3 class="text-lg font-semibold text-slate-800 mb-4 flex items-center gap-2">
              <i class="fas fa-upload text-emerald-600"></i>
              Or upload your own image
            </h3>
            <div class="flex items-center gap-2 mb-4">
              <input type="checkbox" id="useBoundaryCheckbox"
                class="rounded border-slate-300 text-emerald-600 focus:ring-emerald-500">
              <label for="useBoundaryCheckbox" class="text-sm text-slate-700">Analyze within selected farm boundary
                only</label>
            </div>
            <p class="text-sm text-slate-600 mb-2">Or try instantly with a sample field image (great for demos &amp; judges):</p>
            <button type="button" id="trySampleImageBtn"
              class="btn-glass mb-4 px-4 py-2 text-amber-700 rounded-xl font-medium border-amber-200/80">
              <i class="fas fa-magic mr-2"></i>Try with sample image
            </button>
            <form id="uploadForm" class="space-y-4">
              <div
                class="border-2 border-dashed border-slate-300 rounded-lg p-8 text-center hover:border-emerald-400 transition">
                <i class="fas fa-cloud-upload-alt text-4xl text-slate-400 mb-4"></i>
                <p class="text-slate-600 mb-2">Choose an image file (optional if you used &quot;Capture map&quot; above)
                </p>
                <input type="file" id="imageFile" name="file" accept="image/*"
                  class="block w-full text-sm text-slate-600 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-emerald-50 file:text-emerald-700 hover:file:bg-emerald-100" />
              </div>
              <p id="uploadError" class="text-sm text-red-600 hidden"></p>
              <p id="analyzeHint" class="text-sm text-slate-500">Draw boundary and capture map, or upload an image to
                enable Analyze.</p>
              <button type="submit" id="analyzeBtn"
                class="btn-primary w-full py-3 text-white font-semibold rounded-xl flex items-center justify-center gap-2 disabled:opacity-60 disabled:cursor-not-allowed"
                disabled>
                <span id="analyzeBtnText">Analyze Image</span>
                <span id="analyzeSpinner" class="hidden">
                  <i class="fas fa-spinner fa-spin"></i>
                </span>
              </button>
            </form>
          </div>

          <!-- How to Capture Good Images -->
          <div class="bg-blue-50 rounded-xl shadow-md border border-blue-200 p-6 mb-6">
            <h3 class="text-lg font-semibold text-blue-800 mb-3 flex items-center gap-2">
              <i class="fas fa-camera text-blue-600"></i>
              How to Capture Good Images
            </h3>
            <ul class="space-y-2 text-sm text-blue-700">
              <li class="flex items-start gap-2">
                <i class="fas fa-check text-blue-500 mt-0.5"></i>
                <span>Capture during daylight hours for best visibility</span>
              </li>
              <li class="flex items-start gap-2">
                <i class="fas fa-check text-blue-500 mt-0.5"></i>
                <span>Avoid heavy shadows that can hide crop areas</span>
              </li>
              <li class="flex items-start gap-2">
                <i class="fas fa-check text-blue-500 mt-0.5"></i>
                <span>Keep camera steady to avoid motion blur</span>
              </li>
              <li class="flex items-start gap-2">
                <i class="fas fa-check text-blue-500 mt-0.5"></i>
                <span>Ensure the full field is visible in the image</span>
              </li>
            </ul>
          </div>

          <!-- Save place modal -->
          <div id="savePlaceModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-xl shadow-xl p-6 max-w-sm w-full mx-4">
              <h4 class="text-lg font-semibold text-slate-800 mb-4">
                <i class="fas fa-save text-emerald-600 mr-2"></i>Save this place
              </h4>
              <p class="text-sm text-slate-600 mb-4">Give it a name so you can load it next time without redrawing the map.</p>
              <div class="space-y-3">
                <div>
                  <label class="block text-sm font-medium text-slate-700 mb-1">Place name *</label>
                  <input type="text" id="savePlaceName" placeholder="e.g., North field, Main farm"
                    class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500" />
                </div>
                <div>
                  <label class="block text-sm font-medium text-slate-700 mb-1">Place / city (optional)</label>
                  <input type="text" id="savePlaceLocation" placeholder="e.g., Delhi"
                    class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500" />
                </div>
                <div>
                  <label class="block text-sm font-medium text-slate-700 mb-1">Pincode (optional)</label>
                  <input type="text" id="savePlacePincode" placeholder="e.g., 110001"
                    class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500" />
                </div>
              </div>
              <div class="flex gap-3 mt-4">
                <button type="button" id="savePlaceConfirmBtn" class="flex-1 px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 font-medium">
                  Save
                </button>
                <button type="button" id="savePlaceCancelBtn" class="px-4 py-2 bg-slate-200 text-slate-700 rounded-lg hover:bg-slate-300 font-medium">
                  Cancel
                </button>
              </div>
            </div>
          </div>

          <!-- Results Card -->
          <div id="resultsCard" class="hidden glass-card rounded-2xl p-6 border border-white/40">
            <div id="withinBoundaryMessage"
              class="hidden mb-4 rounded-lg bg-emerald-50 border border-emerald-200 px-4 py-3 text-sm text-emerald-800">
              <i class="fas fa-info-circle mr-2"></i>Analysis performed within selected farm boundary.
            </div>
            <div id="savePlaceResultRow" class="hidden mb-4">
              <button type="button" id="savePlaceFromResultsBtn"
                class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-medium text-sm">
                <i class="fas fa-save mr-2"></i>Save this place for next time
              </button>
            </div>
            <h3 class="text-lg font-semibold text-slate-800 mb-6">Analysis Results</h3>

            <!-- Image Previews (larger map windows) - aligned panels -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-5 mb-6 items-start">
              <div class="text-center flex flex-col">
                <div class="analysis-panel-caption mb-2">
                  <p class="text-xs font-medium text-slate-500">Original</p>
                </div>
                <div class="aspect-[4/3] min-h-[220px] rounded-lg bg-slate-100 overflow-hidden border border-slate-200 flex-shrink-0">
                  <img id="originalPreview" src="" alt="Original" class="w-full h-full object-cover hidden min-h-[220px]" />
                  <span id="originalPlaceholder"
                    class="text-slate-400 text-sm flex items-center justify-center min-h-[220px]">—</span>
                </div>
              </div>
              <div class="text-center flex flex-col">
                <div class="analysis-panel-caption mb-2">
                  <p class="text-xs font-medium text-slate-500">Binary Mask</p>
                </div>
                <div class="aspect-[4/3] min-h-[220px] rounded-lg bg-slate-100 overflow-hidden border border-slate-200 flex-shrink-0">
                  <img id="binaryMaskPreview" src="" alt="Binary mask" class="w-full h-full object-cover hidden min-h-[220px]" />
                  <span id="binaryMaskPlaceholder"
                    class="text-slate-400 text-sm flex items-center justify-center min-h-[220px]">—</span>
                </div>
              </div>
              <div class="text-center flex flex-col">
                <div class="analysis-panel-caption mb-2">
                  <p class="text-xs font-medium text-slate-500">Overlay</p>
                </div>
                <div class="aspect-[4/3] min-h-[220px] rounded-lg bg-slate-100 overflow-hidden border border-slate-200 flex-shrink-0">
                  <img id="overlayMaskPreview" src="" alt="Overlay mask" class="w-full h-full object-cover hidden min-h-[220px]" />
                  <span id="overlayMaskPlaceholder"
                    class="text-slate-400 text-sm flex items-center justify-center min-h-[220px]">—</span>
                </div>
              </div>
              <div class="text-center flex flex-col">
                <div class="analysis-panel-caption mb-2">
                  <p class="text-xs font-medium text-slate-500">Land use</p>
                  <p class="text-xs text-slate-400">Water · Roads · Buildings · Vegetation · Bare soil</p>
                </div>
                <div class="aspect-[4/3] min-h-[220px] rounded-lg bg-slate-100 overflow-hidden border border-slate-200 flex-shrink-0">
                  <img id="landUseMaskPreview" src="" alt="Land use mask" class="w-full h-full object-cover hidden min-h-[220px]" />
                  <span id="landUseMaskPlaceholder"
                    class="text-slate-400 text-sm flex items-center justify-center min-h-[220px]">—</span>
                </div>
              </div>
            </div>

            <!-- Key Metrics -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
              <div class="bg-gradient-to-br from-emerald-50 to-emerald-100 rounded-lg p-4 border border-emerald-200">
                <div class="flex items-center justify-between mb-2">
                  <span class="text-sm text-emerald-700 font-medium">Cultivated %</span>
                  <button type="button" class="info-tooltip-btn"
                    data-tooltip="Percentage of your land currently under crop growth.">
                    <i class="fas fa-info-circle text-emerald-600 text-xs"></i>
                  </button>
                </div>
                <p id="cultivatedPct" class="text-3xl font-bold text-emerald-800">—</p>
              </div>

              <div class="bg-gradient-to-br from-amber-50 to-amber-100 rounded-lg p-4 border border-amber-200">
                <div class="flex items-center justify-between mb-2">
                  <span class="text-sm text-amber-700 font-medium">Stress %</span>
                </div>
                <p id="stressPct" class="text-3xl font-bold text-amber-800">—</p>
              </div>

              <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg p-4 border border-blue-200">
                <div class="flex items-center justify-between mb-2">
                  <span class="text-sm text-blue-700 font-medium">Confidence</span>
                  <button type="button" class="info-tooltip-btn"
                    data-tooltip="Reliability score based on image quality and segmentation clarity.">
                    <i class="fas fa-info-circle text-blue-600 text-xs"></i>
                  </button>
                </div>
                <p id="trustScore" class="text-3xl font-bold text-blue-800">—</p>
              </div>
            </div>

            <!-- Classification -->
            <div class="mb-6 rounded-lg bg-slate-50 border border-slate-200 px-4 py-3 text-center">
              <p class="text-slate-600 text-sm mb-1 flex items-center justify-center gap-2">
                Classification
                <button type="button" class="info-tooltip-btn" data-tooltip="Shows how well your field is cultivated.">
                  <i class="fas fa-info-circle text-emerald-600 text-xs"></i>
                </button>
              </p>
              <p id="classificationResult" class="font-semibold text-xl text-slate-800">—</p>
            </div>

            <!-- Detailed Stats -->
            <div class="mb-6 rounded-lg border border-slate-200 bg-slate-50 px-4 py-3">
              <p class="text-slate-600 text-sm font-medium mb-3">Area Statistics</p>
              <div id="boundaryPortionStats" class="hidden mb-3 p-3 bg-emerald-50 rounded-lg border border-emerald-200 text-sm">
                <p class="font-medium text-emerald-800 mb-2">Selected region vs full image</p>
                <div class="grid grid-cols-2 gap-x-4 gap-y-1 text-slate-700">
                  <span>Full image</span>
                  <span id="fullImagePixels" class="font-mono text-right">—</span>
                  <span>Selected region (inside boundary)</span>
                  <span id="insideBoundaryPct" class="font-mono text-right">—</span>
                  <span>Remaining (outside boundary)</span>
                  <span id="outsideBoundaryPct" class="font-mono text-right">—</span>
                </div>
              </div>
              <div class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm">
                <span class="text-slate-500">Total pixels <span id="totalPixelsLabel" class="text-slate-400">(in selected region)</span></span>
                <span id="totalPixels" class="font-mono text-slate-800 text-right">—</span>
                <span class="text-slate-500">Cultivated pixels</span>
                <span id="cultivatedPixels" class="font-mono text-slate-800 text-right">—</span>
                <span class="text-slate-500">Non-cultivated pixels</span>
                <span id="nonCultivatedPixels" class="font-mono text-slate-800 text-right">—</span>
                <span class="text-slate-500">Coverage ratio</span>
                <span id="coverageRatio" class="font-mono text-slate-800 text-right">—</span>
              </div>
            </div>

            <!-- Advisory -->
            <div class="pt-4 border-t border-slate-200 text-center mb-6">
              <p class="text-slate-600 text-sm mb-2">Advisory</p>
              <p id="advisory" class="font-semibold text-xl text-slate-800">—</p>
            </div>
            <div class="flex flex-wrap gap-3 justify-center mb-6">
              <button type="button" id="downloadReportBtn"
                class="px-4 py-2 bg-slate-700 text-white rounded-lg hover:bg-slate-800 transition font-medium">
                <i class="fas fa-file-pdf mr-2"></i>Download / Print report
              </button>
            </div>

            <!-- Land Use Breakdown -->
            <div id="landUseBreakdown"
              class="hidden mb-6 bg-gradient-to-br from-slate-50 to-slate-100 rounded-xl border border-slate-200 p-6">
              <h4 class="font-semibold text-slate-800 mb-4 flex items-center gap-2">
                <i class="fas fa-map text-indigo-600"></i>
                Detected Land Use Breakdown
              </h4>
              <div class="space-y-3">
                <div class="flex items-center gap-3">
                  <span class="w-3 h-3 rounded-full bg-emerald-500 flex-shrink-0"></span>
                  <span class="text-sm text-slate-600 w-24">Vegetation</span>
                  <div class="flex-1 min-w-0 h-6 bg-slate-200 rounded-full overflow-hidden flex">
                    <div id="barVegetation" class="landuse-bar-fill h-full rounded-full bg-emerald-500 transition-all duration-300" style="width:0%; min-width:0"></div>
                  </div>
                  <span id="pctVegetation" class="text-sm font-semibold text-slate-800 w-14 text-right shrink-0">0%</span>
                </div>
                <div class="flex items-center gap-3">
                  <span class="w-3 h-3 rounded-full bg-blue-500 flex-shrink-0"></span>
                  <span class="text-sm text-slate-600 w-24">Water</span>
                  <div class="flex-1 min-w-0 h-6 bg-slate-200 rounded-full overflow-hidden flex">
                    <div id="barWater" class="landuse-bar-fill h-full rounded-full bg-blue-500 transition-all duration-300" style="width:0%; min-width:0"></div>
                  </div>
                  <span id="pctWater" class="text-sm font-semibold text-slate-800 w-14 text-right shrink-0">0%</span>
                </div>
                <div class="flex items-center gap-3">
                  <span class="w-3 h-3 rounded-full bg-gray-400 flex-shrink-0"></span>
                  <span class="text-sm text-slate-600 w-24">Roads</span>
                  <div class="flex-1 min-w-0 h-6 bg-slate-200 rounded-full overflow-hidden flex">
                    <div id="barRoads" class="landuse-bar-fill h-full rounded-full bg-gray-400 transition-all duration-300" style="width:0%; min-width:0"></div>
                  </div>
                  <span id="pctRoads" class="text-sm font-semibold text-slate-800 w-14 text-right shrink-0">0%</span>
                </div>
                <div class="flex items-center gap-3">
                  <span class="w-3 h-3 rounded-full bg-amber-700 flex-shrink-0"></span>
                  <span class="text-sm text-slate-600 w-24">Buildings</span>
                  <div class="flex-1 min-w-0 h-6 bg-slate-200 rounded-full overflow-hidden flex">
                    <div id="barBuildings" class="landuse-bar-fill h-full rounded-full bg-amber-700 transition-all duration-300" style="width:0%; min-width:0"></div>
                  </div>
                  <span id="pctBuildings" class="text-sm font-semibold text-slate-800 w-14 text-right shrink-0">0%</span>
                </div>
                <div class="flex items-center gap-3 pt-2 border-t border-slate-200">
                  <span class="w-3 h-3 rounded-full bg-lime-500 flex-shrink-0"></span>
                  <span class="text-sm text-slate-700 font-medium w-24">Farmable</span>
                  <div class="flex-1 min-w-0 h-6 bg-slate-200 rounded-full overflow-hidden flex">
                    <div id="barFarmable" class="landuse-bar-fill h-full rounded-full bg-lime-500 transition-all duration-300" style="width:0%; min-width:0"></div>
                  </div>
                  <span id="pctFarmable" class="text-sm font-bold text-lime-700 w-14 text-right shrink-0">0%</span>
                </div>
              </div>
            </div>

            <!-- Crop Recommendations -->
            <div id="cropRecommendationsSection" class="hidden mb-6">
              <div
                class="bg-gradient-to-br from-emerald-50 via-teal-50 to-cyan-50 rounded-xl border border-emerald-200 p-6">
                <div class="flex items-center justify-between mb-2">
                  <h4 class="font-semibold text-emerald-900 text-lg flex items-center gap-2">
                    <i class="fas fa-seedling text-emerald-600"></i>
                    AI Crop Recommendations
                  </h4>
                  <span id="cropSeasonBadge"
                    class="px-3 py-1 rounded-full text-xs font-semibold bg-emerald-100 text-emerald-800"></span>
                </div>
                <p id="cropSummaryText" class="text-sm text-emerald-700 mb-1"></p>
                <p id="cropConditionsText" class="text-xs text-slate-500 mb-4"></p>

                <!-- Loading state -->
                <div id="cropLoading" class="hidden flex items-center justify-center py-8">
                  <i class="fas fa-spinner fa-spin text-emerald-500 text-2xl mr-3"></i>
                  <span class="text-emerald-700">Analyzing conditions &amp; finding best crops...</span>
                </div>

                <!-- Primary recommendation + sub-suggestions -->
                <div id="cropPrimarySection" class="hidden mb-4">
                  <h5 class="font-semibold text-emerald-800 mb-2 flex items-center gap-2">
                    <i class="fas fa-star text-yellow-500"></i> Top recommendation
                  </h5>
                  <div id="cropPrimaryCard" class="mb-4"></div>
                  <h6 class="font-medium text-teal-800 mb-2 flex items-center gap-2 text-sm">
                    <i class="fas fa-list-ul text-teal-500"></i> Also consider
                  </h6>
                  <div id="cropSubSuggestions" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2"></div>
                </div>

                <!-- Highly Recommended (fallback) -->
                <div id="cropHighlyRecommended" class="hidden">
                  <h5 class="font-semibold text-emerald-800 mb-3 flex items-center gap-2">
                    <i class="fas fa-star text-yellow-500"></i> Highly Recommended
                  </h5>
                  <div id="cropHighList" class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4"></div>
                </div>

                <!-- Moderately Suitable -->
                <div id="cropModeratelySuitable" class="hidden">
                  <button type="button" id="toggleModCrops"
                    class="w-full flex items-center justify-between py-2 px-3 rounded-lg bg-white/60 hover:bg-white/80 border border-emerald-200 mb-3 transition">
                    <span class="text-sm font-semibold text-teal-800 flex items-center gap-2">
                      <i class="fas fa-thumbs-up text-teal-500"></i> Moderately Suitable
                      <span id="modCropCount" class="text-xs bg-teal-100 text-teal-700 px-2 py-0.5 rounded-full"></span>
                    </span>
                    <span id="modCropToggleIcon" class="text-teal-600 text-sm">&#9660;</span>
                  </button>
                  <div id="cropModList" class="hidden grid grid-cols-1 md:grid-cols-2 gap-3 mb-4"></div>
                </div>

                <!-- Summary footer -->
                <div id="cropFooter" class="hidden pt-3 border-t border-emerald-200">
                  <p class="text-xs text-slate-500">
                    <i class="fas fa-info-circle mr-1"></i>
                    <span id="cropEvalSummary"></span>
                  </p>
                </div>
              </div>
            </div>

            <!-- Low Confidence Warning -->
            <div id="lowConfidenceWarning" class="hidden rounded-lg border border-red-300 bg-red-50 p-4 mb-4">
              <div class="flex items-start gap-3">
                <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
                <div>
                  <p class="font-semibold text-red-800 mb-1">Image Quality Warning</p>
                  <p class="text-sm text-red-700">Image quality is low. Please capture a clearer aerial image for better
                    accuracy.</p>
                </div>
              </div>
            </div>

            <!-- Explanation Section -->
            <div class="border-t border-slate-200 pt-6">
              <button type="button" id="explanationToggle"
                class="w-full flex items-center justify-between text-left py-3 px-4 rounded-lg bg-emerald-50 hover:bg-emerald-100 border border-emerald-200 transition-colors">
                <span class="font-semibold text-emerald-800 flex items-center gap-2">
                  <i class="fas fa-lightbulb"></i>
                  <span>Learn How This Analysis Works</span>
                </span>
                <span id="explanationToggleIcon" class="text-emerald-600">▼</span>
              </button>
              <div id="explanationSection" class="hidden mt-4 space-y-4">
                <div class="bg-slate-50 rounded-lg border border-slate-200 p-4">
                  <h4 class="font-semibold text-slate-800 mb-2">1️⃣ What is Vegetation Detection?</h4>
                  <p class="text-sm text-slate-700 mb-2">AGNI detects green crop regions using a vegetation index that
                    highlights plant growth areas.</p>
                  <p class="text-xs text-slate-600 italic"><strong>Why it matters:</strong> This ensures only crop areas
                    are counted, not soil or non-farm regions.</p>
                </div>
                <div class="bg-slate-50 rounded-lg border border-slate-200 p-4">
                  <h4 class="font-semibold text-slate-800 mb-2">2️⃣ Why Are Roads and Rivers Removed?</h4>
                  <p class="text-sm text-slate-700 mb-2">AGNI automatically removes permanent features such as roads,
                    water bodies, and buildings.</p>
                  <p class="text-xs text-slate-600 italic"><strong>Why it matters:</strong> This improves accuracy by
                    focusing only on farmable land.</p>
                </div>
                <div class="bg-slate-50 rounded-lg border border-slate-200 p-4">
                  <h4 class="font-semibold text-slate-800 mb-2">3️⃣ What Does Cultivated Area Percentage Mean?</h4>
                  <p class="text-sm text-slate-700">This value shows how much of your field is actively cultivated.
                    Higher percentages indicate more land under crop growth.</p>
                </div>
                <div class="bg-slate-50 rounded-lg border border-slate-200 p-4">
                  <h4 class="font-semibold text-slate-800 mb-2">4️⃣ What Is Mask Confidence Score?</h4>
                  <p class="text-sm text-slate-700 mb-3">This score indicates how reliable the analysis is. It is
                    calculated using image clarity, segmentation consistency, and area stability.</p>
                  <div class="text-xs text-slate-600 space-y-1">
                    <p><strong>Interpretation:</strong></p>
                    <p>• <strong>80–100</strong> → Highly reliable</p>
                    <p>• <strong>60–80</strong> → Moderately reliable</p>
                    <p>• <strong>Below 60</strong> → Re-upload clearer image</p>
                  </div>
                </div>
                <div class="bg-slate-50 rounded-lg border border-slate-200 p-4">
                  <h4 class="font-semibold text-slate-800 mb-2">5️⃣ What Is the Polygon Boundary?</h4>
                  <p class="text-sm text-slate-700 mb-2">The highlighted boundary shows the exact cultivated region
                    detected within your field.</p>
                  <p class="text-xs text-slate-600 italic"><strong>Why it matters:</strong> This helps measure actual
                    cultivated area accurately.</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- AI Suggestion Page (plot-based advice for farmers) -->
        <div id="page-ai-suggestion" class="page-content hidden">
          <div class="glass-card rounded-2xl p-6 mb-6">
            <h3 class="text-lg font-semibold text-slate-800 mb-2 flex items-center gap-2">
              <i class="fas fa-lightbulb text-amber-500"></i>
              Get suggestions for your plot
            </h3>
            <p class="text-sm text-slate-600 mb-4">Select a plot (use your last analyzed image data or current location) to see whether it is suitable for agriculture and get crop and farming suggestions.</p>
            <div class="flex flex-wrap gap-3">
              <button type="button" id="aiSuggestionUseLastPlotBtn"
                class="px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition font-medium disabled:opacity-50 disabled:cursor-not-allowed">
                <i class="fas fa-image mr-2"></i>Use last analyzed plot
              </button>
              <button type="button" id="aiSuggestionUseLocationBtn"
                class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-medium">
                <i class="fas fa-map-marker-alt mr-2"></i>Use current location
              </button>
            </div>
            <p id="aiSuggestionPlotHint" class="text-sm text-slate-500 mt-2">If you have not analyzed an image yet, use &quot;Use current location&quot; and optionally enter land-use estimates below.</p>
          </div>
          <div id="aiSuggestionFormCard" class="glass-card rounded-2xl p-6 mb-6">
            <h4 class="font-semibold text-slate-800 mb-3">Plot location (required) and details</h4>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
              <div>
                <label class="block text-sm text-slate-600 mb-1">Latitude</label>
                <input type="number" id="aiSuggestionLat" step="any" placeholder="e.g. 20.59"
                  class="input-glass w-full px-3 py-2 rounded-xl">
              </div>
              <div>
                <label class="block text-sm text-slate-600 mb-1">Longitude</label>
                <input type="number" id="aiSuggestionLon" step="any" placeholder="e.g. 78.96"
                  class="input-glass w-full px-3 py-2 rounded-xl">
              </div>
              <div>
                <label class="block text-sm text-slate-600 mb-1">Cultivated %</label>
                <input type="number" id="aiSuggestionCultivatedPct" min="0" max="100" value="50" step="1"
                  class="input-glass w-full px-3 py-2 rounded-xl">
              </div>
              <div>
                <label class="block text-sm text-slate-600 mb-1">Water %</label>
                <input type="number" id="aiSuggestionWaterPct" min="0" max="100" value="5" step="0.5"
                  class="input-glass w-full px-3 py-2 rounded-xl">
              </div>
              <div>
                <label class="block text-sm text-slate-600 mb-1">Farmable space %</label>
                <input type="number" id="aiSuggestionFarmablePct" min="0" max="100" value="50" step="1"
                  class="input-glass w-full px-3 py-2 rounded-xl">
              </div>
              <div>
                <label class="block text-sm text-slate-600 mb-1">Building %</label>
                <input type="number" id="aiSuggestionBuildingPct" min="0" max="100" value="0" step="1"
                  class="input-glass w-full px-3 py-2 rounded-xl">
              </div>
            </div>
            <div class="flex gap-3">
              <button type="button" id="aiSuggestionGetBtn"
                class="btn-primary px-6 py-2 text-white rounded-xl font-medium">
                <i class="fas fa-magic mr-2"></i>Get suggestion
              </button>
              <span id="aiSuggestionStatus" class="text-sm text-slate-500 self-center"></span>
            </div>
          </div>
          <div id="aiSuggestionResult" class="hidden space-y-6">
            <div id="aiSuggestionSuitabilityCard" class="glass-card rounded-2xl p-6">
              <h4 class="font-semibold text-slate-800 mb-2 flex items-center gap-2">
                <i class="fas fa-check-circle text-emerald-600" id="aiSuggestionSuitabilityIcon"></i>
                <span id="aiSuggestionSuitabilityLabel">Suitability</span>
              </h4>
              <p id="aiSuggestionSuitabilityMessage" class="text-slate-700 mb-4"></p>
              <ul id="aiSuggestionBullets" class="list-disc list-inside space-y-1 text-slate-600 text-sm"></ul>
            </div>
            <div id="aiSuggestionWeatherCropRow" class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div id="aiSuggestionWeatherCard" class="glass-card rounded-2xl p-6 hidden">
                <h4 class="font-semibold text-slate-800 mb-2"><i class="fas fa-cloud-sun text-blue-500 mr-2"></i>Weather at plot</h4>
                <p id="aiSuggestionWeatherText" class="text-slate-600"></p>
              </div>
              <div id="aiSuggestionCropsCard" class="glass-card rounded-2xl p-6">
                <h4 class="font-semibold text-slate-800 mb-2"><i class="fas fa-seedling text-emerald-600 mr-2"></i>Top crop suggestions</h4>
                <p id="aiSuggestionSeason" class="text-sm text-slate-500 mb-3"></p>
                <div id="aiSuggestionCropsList" class="space-y-2"></div>
              </div>
            </div>
            <div class="flex justify-end">
              <button type="button" id="aiSuggestionDownloadReportBtn"
                class="px-4 py-2 bg-slate-700 text-white rounded-lg hover:bg-slate-800 transition font-medium">
                <i class="fas fa-file-pdf mr-2"></i>Download / Print suggestion report
              </button>
            </div>
          </div>
        </div>

        <!-- Weather Page -->
        <div id="page-weather" class="page-content hidden">
          <div class="glass-card rounded-2xl p-6 mb-6">
            <h3 class="text-lg font-semibold text-slate-800 mb-4 flex items-center gap-2">
              <i class="fas fa-map-marker-alt text-emerald-600"></i>
              Location
            </h3>
            <div class="mb-4 p-3 bg-emerald-50 rounded-lg border border-emerald-200">
              <div class="flex items-center gap-2 text-sm text-emerald-700">
                <i class="fas fa-info-circle"></i>
                <span>Using your current location by default. You can search for other locations if needed.</span>
              </div>
            </div>
            <div class="flex gap-3">
              <input type="text" id="weatherLocation" placeholder="Search city name (optional)"
                class="input-glass flex-1 px-4 py-2 rounded-xl">
              <button id="fetchWeatherBtn"
                class="btn-primary px-6 py-2 text-white rounded-xl">
                <i class="fas fa-search mr-2"></i>Get Weather
              </button>
              <button id="useMyLocationBtn"
                class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                <i class="fas fa-crosshairs mr-2"></i>My Location
              </button>
            </div>
            <p id="weatherLocationStatus" class="text-sm text-slate-500 mt-2"></p>
          </div>

          <div id="weatherContent" class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl shadow-xl text-white p-6 border border-white/20">
              <div class="flex items-center justify-between mb-4">
                <div>
                  <p class="text-blue-100 text-sm mb-1" id="weatherLocationName">Loading...</p>
                  <p class="text-2xl font-bold" id="weatherTemp">—</p>
                </div>
                <div class="text-6xl" id="weatherIcon">
                  <i class="fas fa-sun"></i>
                </div>
              </div>
              <p class="text-blue-100 mb-4" id="weatherDescription">—</p>
              <div class="grid grid-cols-2 gap-4 pt-4 border-t border-blue-400">
                <div>
                  <p class="text-blue-100 text-xs mb-1">Feels Like</p>
                  <p class="text-xl font-semibold" id="weatherFeelsLike">—</p>
                </div>
                <div>
                  <p class="text-blue-100 text-xs mb-1">Humidity</p>
                  <p class="text-xl font-semibold" id="weatherHumidity">—</p>
                </div>
                <div>
                  <p class="text-blue-100 text-xs mb-1">Wind Speed</p>
                  <p class="text-xl font-semibold" id="weatherWind">—</p>
                </div>
                <div>
                  <p class="text-blue-100 text-xs mb-1">Pressure</p>
                  <p class="text-xl font-semibold" id="weatherPressure">—</p>
                </div>
              </div>
            </div>

            <div class="glass-card rounded-2xl p-6">
              <h3 class="text-lg font-semibold text-slate-800 mb-4">Agricultural Impact</h3>
              <div id="weatherImpact" class="space-y-3">
                <div class="flex items-start gap-3 p-3 bg-emerald-50 rounded-lg">
                  <i class="fas fa-seedling text-emerald-600 mt-1"></i>
                  <div>
                    <p class="font-medium text-slate-800">Crop Conditions</p>
                    <p class="text-sm text-slate-600" id="cropConditions">Analyzing...</p>
                  </div>
                </div>
                <div class="flex items-start gap-3 p-3 bg-blue-50 rounded-lg">
                  <i class="fas fa-tint text-blue-600 mt-1"></i>
                  <div>
                    <p class="font-medium text-slate-800">Irrigation Advice</p>
                    <p class="text-sm text-slate-600" id="irrigationAdvice">Analyzing...</p>
                  </div>
                </div>
                <div class="flex items-start gap-3 p-3 bg-amber-50 rounded-lg">
                  <i class="fas fa-calendar-alt text-amber-600 mt-1"></i>
                  <div>
                    <p class="font-medium text-slate-800">Field Work Recommendation</p>
                    <p class="text-sm text-slate-600" id="fieldWorkAdvice">Analyzing...</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- News Page -->
        <div id="page-news" class="page-content hidden">
          <div class="glass-card rounded-2xl p-6">
            <h3 class="text-lg font-semibold text-slate-800 mb-4 flex items-center gap-2">
              <i class="fas fa-newspaper text-emerald-600"></i>
              Latest Agricultural News
            </h3>
            <div id="newsList" class="space-y-4">
              <div class="flex items-center justify-center py-8">
                <i class="fas fa-spinner fa-spin text-slate-400 text-2xl"></i>
                <span class="ml-3 text-slate-600">Loading news...</span>
              </div>
            </div>
          </div>
        </div>

        <!-- My Lands Page -->
        <div id="page-my-lands" class="page-content hidden">
          <div class="glass-card rounded-2xl p-6 mb-6">
            <div class="flex items-center justify-between mb-6">
              <h3 class="text-lg font-semibold text-slate-800 flex items-center gap-2">
                <i class="fas fa-map-marked-alt text-emerald-600"></i>
                My Lands
              </h3>
              <button type="button" id="addLandBtn"
                class="px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition font-medium">
                <i class="fas fa-plus mr-2"></i>Add New Land
              </button>
            </div>
            <p class="text-sm text-slate-600 mb-4">Manage your multiple farm locations. Click a place to see current weather and crop analysis.</p>
            <div id="landsList" class="space-y-4">
              <p class="text-slate-400 text-sm text-center py-8">No lands saved yet. Click "Add New Land" or save a place from Image Analyzer.</p>
            </div>
          </div>

          <!-- Land/Place detail modal (current weather + crops) -->
          <div id="landDetailModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-xl shadow-xl max-w-lg w-full max-h-[90vh] overflow-hidden flex flex-col">
              <div class="p-6 border-b border-slate-200 flex-shrink-0">
                <div class="flex items-start justify-between">
                  <div>
                    <h4 id="landDetailName" class="text-xl font-semibold text-slate-800">—</h4>
                    <p id="landDetailLocation" class="text-sm text-slate-600 mt-1">—</p>
                  </div>
                  <button type="button" id="closeLandDetailModal" class="text-slate-400 hover:text-slate-600">
                    <i class="fas fa-times text-xl"></i>
                  </button>
                </div>
              </div>
              <div id="landDetailLoading" class="p-6 flex items-center justify-center gap-2 text-slate-500">
                <i class="fas fa-spinner fa-spin"></i>
                <span>Loading current weather &amp; analysis...</span>
              </div>
              <div id="landDetailContent" class="hidden flex-1 overflow-y-auto p-6 space-y-4">
                <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg p-4 border border-blue-200">
                  <h5 class="font-semibold text-blue-900 mb-2 flex items-center gap-2">
                    <i class="fas fa-cloud-sun"></i> Current weather
                  </h5>
                  <p id="landDetailWeatherTemp" class="text-2xl font-bold text-blue-800">—</p>
                  <p id="landDetailWeatherDesc" class="text-sm text-blue-700">—</p>
                  <p id="landDetailWeatherExtra" class="text-xs text-blue-600 mt-2">—</p>
                </div>
                <div id="landDetailCropsBox" class="bg-emerald-50 rounded-lg p-4 border border-emerald-200">
                  <h5 class="font-semibold text-emerald-900 mb-2 flex items-center gap-2">
                    <i class="fas fa-seedling"></i> Crop recommendations (current conditions)
                  </h5>
                  <p id="landDetailCropsSummary" class="text-sm text-emerald-800">—</p>
                  <div id="landDetailCropsPrimary" class="mt-2 p-3 bg-white rounded-lg border border-emerald-200"></div>
                  <div id="landDetailCropsSub" class="mt-2 space-y-1 text-sm text-emerald-800"></div>
                </div>
              </div>
              <div class="p-4 border-t border-slate-200 flex-shrink-0 flex gap-2">
                <button type="button" id="landDetailOpenAnalyzerBtn" class="flex-1 px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 font-medium text-sm hidden">
                  <i class="fas fa-map mr-2"></i>Open in Image Analyzer
                </button>
                <button type="button" id="closeLandDetailModalBtn" class="px-4 py-2 bg-slate-200 text-slate-700 rounded-lg hover:bg-slate-300 font-medium text-sm">
                  Close
                </button>
              </div>
            </div>
          </div>
          
          <!-- Add/Edit Land Modal -->
          <div id="landModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-xl shadow-xl p-6 max-w-md w-full mx-4">
              <div class="flex items-center justify-between mb-4">
                <h4 class="text-xl font-semibold text-slate-800" id="landModalTitle">Add New Land</h4>
                <button type="button" id="closeLandModal" class="text-slate-400 hover:text-slate-600">
                  <i class="fas fa-times text-xl"></i>
                </button>
              </div>
              <form id="landForm" class="space-y-4">
                <input type="hidden" id="landId" />
                <div>
                  <label class="block text-sm font-medium text-slate-700 mb-2">
                    <i class="fas fa-tag mr-2 text-emerald-600"></i>Land Name
                  </label>
                  <input type="text" id="landName" required
                    class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500"
                    placeholder="e.g., North Field, Main Farm" />
                </div>
                <div>
                  <label class="block text-sm font-medium text-slate-700 mb-2">
                    <i class="fas fa-map-pin mr-2 text-emerald-600"></i>Pincode
                  </label>
                  <input type="text" id="landPincode"
                    class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500"
                    placeholder="e.g., 110001" />
                </div>
                <div>
                  <label class="block text-sm font-medium text-slate-700 mb-2">
                    <i class="fas fa-city mr-2 text-emerald-600"></i>Place / City
                  </label>
                  <input type="text" id="landPlace" required
                    class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500"
                    placeholder="e.g., Delhi, New Delhi" />
                </div>
                <div>
                  <label class="block text-sm font-medium text-slate-700 mb-2">
                    <i class="fas fa-info-circle mr-2 text-emerald-600"></i>Notes (optional)
                  </label>
                  <textarea id="landNotes" rows="3"
                    class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500"
                    placeholder="Additional details about this land..."></textarea>
                </div>
                <div class="flex items-center gap-2">
                  <input type="checkbox" id="landUseFingerprint" class="rounded border-slate-300 text-emerald-600 focus:ring-emerald-500" />
                  <label for="landUseFingerprint" class="text-sm text-slate-700">
                    <i class="fas fa-fingerprint mr-1"></i>Require fingerprint to access this land
                  </label>
                </div>
                <div class="flex gap-3 pt-2">
                  <button type="submit"
                    class="flex-1 px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition font-medium">
                    <i class="fas fa-save mr-2"></i>Save
                  </button>
                  <button type="button" id="cancelLandForm"
                    class="px-4 py-2 bg-slate-200 text-slate-700 rounded-lg hover:bg-slate-300 transition font-medium">
                    Cancel
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>

        <!-- Profile Page -->
        <div id="page-profile" class="page-content hidden">
          <div class="glass-card rounded-2xl p-6 mb-6">
            <h3 class="text-lg font-semibold text-slate-800 mb-6">Profile Information</h3>
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">Username</label>
                <input type="text" id="profileUsername" readonly
                  class="w-full px-4 py-2 bg-slate-50 border border-slate-300 rounded-lg text-slate-600">
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">Email</label>
                <input type="email" id="profileEmail"
                  class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500"
                  placeholder="your.email@example.com">
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">Farm Name</label>
                <input type="text" id="profileFarmName"
                  class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500"
                  placeholder="Your Farm Name">
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">Location</label>
                <input type="text" id="profileLocation"
                  class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500"
                  placeholder="City, State">
              </div>
              <button id="saveProfileBtn"
                class="w-full py-3 bg-emerald-600 text-white font-semibold rounded-lg hover:bg-emerald-700 transition">
                <i class="fas fa-save mr-2"></i>Save Changes
              </button>
            </div>
          </div>
        </div>

        <!-- Settings Page -->
        <div id="page-settings" class="page-content hidden">
          <div class="glass-card rounded-2xl p-6">
            <h3 class="text-lg font-semibold text-slate-800 mb-6">Settings</h3>
            <div class="space-y-6">
              <div>
                <h4 class="font-medium text-slate-700 mb-3">Notifications</h4>
                <div class="space-y-3">
                  <label
                    class="flex items-center justify-between p-3 border border-slate-200 rounded-lg cursor-pointer hover:bg-slate-50">
                    <span class="text-slate-700">Email notifications</span>
                    <input type="checkbox" class="toggle-checkbox">
                  </label>
                  <label
                    class="flex items-center justify-between p-3 border border-slate-200 rounded-lg cursor-pointer hover:bg-slate-50">
                    <span class="text-slate-700">Analysis alerts</span>
                    <input type="checkbox" checked class="toggle-checkbox">
                  </label>
                </div>
              </div>

              <div>
                <h4 class="font-medium text-slate-700 mb-3">Display Preferences</h4>
                <div class="space-y-3">
                  <label
                    class="flex items-center justify-between p-3 border border-slate-200 rounded-lg cursor-pointer hover:bg-slate-50">
                    <span class="text-slate-700">Dark mode</span>
                    <input type="checkbox" class="toggle-checkbox">
                  </label>
                  <label
                    class="flex items-center justify-between p-3 border border-slate-200 rounded-lg cursor-pointer hover:bg-slate-50">
                    <span class="text-slate-700">Compact view</span>
                    <input type="checkbox" class="toggle-checkbox">
                  </label>
                </div>
              </div>

              <div>
                <h4 class="font-medium text-slate-700 mb-3">Units</h4>
                <select class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500">
                  <option>Metric (Celsius, km)</option>
                  <option>Imperial (Fahrenheit, miles)</option>
                </select>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin></script>
  <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js" crossorigin></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script>
    const API_BASE = 'http://127.0.0.1:8000';
    const WEATHER_API_KEY = '42a28b0639a88def3bb8150c4d61f466';
    let token = localStorage.getItem('agni_token');
    let username = localStorage.getItem('agni_username');

    // DOM Elements
    const loginScreen = document.getElementById('loginScreen');
    const appLayout = document.getElementById('appLayout');
    const loginForm = document.getElementById('loginForm');
    const loginError = document.getElementById('loginError');
    const logoutBtn = document.getElementById('logoutBtn');
    const sidebarUsername = document.getElementById('sidebarUsername');
    const navItems = document.querySelectorAll('.nav-item');
    const pages = document.querySelectorAll('.page-content');
    const pageTitle = document.getElementById('pageTitle');
    const pageSubtitle = document.getElementById('pageSubtitle');

    // Page navigation
    navItems.forEach(item => {
      item.addEventListener('click', (e) => {
        e.preventDefault();
        const page = item.getAttribute('data-page');
        navigateToPage(page);
      });
    });

    function navigateToPage(pageName) {
      // Update nav items
      navItems.forEach(item => {
        item.classList.remove('active', 'bg-emerald-50', 'text-emerald-700');
        if (item.getAttribute('data-page') === pageName) {
          item.classList.add('active', 'bg-emerald-50', 'text-emerald-700');
        }
      });

      // Hide all pages
      pages.forEach(p => p.classList.add('hidden'));

      // Show selected page
      const targetPage = document.getElementById(`page-${pageName}`);
      if (targetPage) {
        targetPage.classList.remove('hidden');
      }

      // Update page title
      const titles = {
        dashboard: { title: 'Dashboard', subtitle: 'Welcome back! Here\'s your overview' },
        analyzer: { title: 'Image Analyzer', subtitle: 'Upload and analyze your field images' },
        'ai-suggestion': { title: 'AI Suggestion', subtitle: 'Get farming suggestions for your plot' },
        weather: { title: 'Weather & Climate', subtitle: 'Check weather conditions for your farm' },
        'my-lands': { title: 'My Lands', subtitle: 'Your saved farm locations' },
        news: { title: 'Agricultural News', subtitle: 'Stay updated with latest farming news' },
        profile: { title: 'Profile', subtitle: 'Manage your account information' },
        settings: { title: 'Settings', subtitle: 'Customize your preferences' }
      };
      if (titles[pageName]) {
        pageTitle.textContent = titles[pageName].title;
        pageSubtitle.textContent = titles[pageName].subtitle;
      }

      // Load page-specific data
      if (pageName === 'weather') {
        fetchWeatherByLocation();
      } else if (pageName === 'news') {
        fetchNews();
      } else if (pageName === 'dashboard') {
        updateDashboard();
      } else if (pageName === 'analyzer') {
        initFarmMapIfNeeded();
        if (typeof refreshSavedPlacesDropdown === 'function') refreshSavedPlacesDropdown();
        if (typeof updateAnalyzeButtonState === 'function') updateAnalyzeButtonState();
      } else if (pageName === 'my-lands') {
        loadMyLands();
      } else if (pageName === 'ai-suggestion') {
        if (typeof updateAiSuggestionLastPlotButton === 'function') updateAiSuggestionLastPlotButton();
      }
    }

    // --- Farm boundary map (Leaflet) ---
    let farmMap = null;
    let drawnItems = null;
    let drawControl = null;
    let confirmedBoundaryCoords = null; // [[lat, lng], ...] after Confirm
    let osmLayer = null;
    let satelliteLayer = null;
    let capturedMapBlob = null; // when "Use map as image" is used
    let locationMarker = null; // marker for pincode/place or current location

    const DEFAULT_MAP_CENTER = [20.5937, 78.9629];
    const DEFAULT_MAP_ZOOM = 5;
    const LOCATION_MAP_ZOOM = 14;

    function initFarmMapIfNeeded() {
      if (document.getElementById('farmMap').offsetParent === null) return;
      if (farmMap) {
        farmMap.invalidateSize();
        return;
      }
      farmMap = L.map('farmMap', { center: DEFAULT_MAP_CENTER, zoom: DEFAULT_MAP_ZOOM });

      osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
      });
      satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        attribution: '&copy; <a href="https://www.esri.com/">Esri</a>'
      });
      satelliteLayer.addTo(farmMap);
      L.control.layers(
        { 'Street': osmLayer, 'Satellite': satelliteLayer },
        {},
        { position: 'topright' }
      ).addTo(farmMap);

      drawnItems = new L.FeatureGroup();
      farmMap.addLayer(drawnItems);

      // Default: center map on user's current location
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          function (pos) {
            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;
            farmMap.setView([lat, lng], LOCATION_MAP_ZOOM);
            setLocationMarker(lat, lng);
          },
          function () { /* keep default center */ }
        );
      }

      drawControl = new L.Control.Draw({
        draw: {
          polygon: {
            allowIntersection: false,
            shapeOptions: { color: '#059669' },
            guidelines: true,
            showLength: true,
            metric: true
          },
          polyline: false,
          circle: false,
          rectangle: false,
          marker: false,
          circlemarker: false
        },
        edit: {
          featureGroup: drawnItems,
          edit: true,
          remove: true
        }
      });
      farmMap.addControl(drawControl);

      farmMap.on(L.Draw.Event.CREATED, function (e) {
        drawnItems.clearLayers();
        drawnItems.addLayer(e.layer);
        document.getElementById('confirmBoundaryBtn').disabled = false;
        document.getElementById('boundarySummary').textContent = 'Drawn. Click "Confirm Farm Boundary" to use.';
        document.getElementById('boundaryError').classList.add('hidden');
      });
      farmMap.on(L.Draw.Event.EDITED, function () {
        document.getElementById('boundarySummary').textContent = 'Edited. Click "Confirm Farm Boundary" to use.';
      });
      farmMap.on(L.Draw.Event.DELETED, function () {
        drawnItems.clearLayers();
        confirmedBoundaryCoords = null;
        document.getElementById('confirmBoundaryBtn').disabled = true;
        document.getElementById('boundarySummary').textContent = '';
        document.getElementById('clearBoundaryBtn').classList.add('hidden');
      });
    }

    function setLocationMarker(lat, lng) {
      if (locationMarker) {
        farmMap.removeLayer(locationMarker);
        locationMarker = null;
      }
      locationMarker = L.marker([lat, lng], {
        icon: L.divIcon({
          className: 'location-pin',
          html: '<i class="fas fa-map-marker-alt text-2xl text-emerald-600" style="margin-left:-12px; margin-top:-24px;"></i>',
          iconSize: [24, 24]
        })
      }).addTo(farmMap);
    }

    async function geocodePincodeOrPlace(query) {
      if (!query || !query.trim()) return null;
      const q = encodeURIComponent(query.trim());
      const url = `https://nominatim.openstreetmap.org/search?q=${q}&format=json&limit=1`;
      try {
        const res = await fetch(url, {
          headers: { 'Accept': 'application/json', 'User-Agent': 'AGNI-Agriculture-App/1.0' }
        });
        const data = await res.json();
        if (data && data[0]) {
          return {
            lat: parseFloat(data[0].lat),
            lon: parseFloat(data[0].lon),
            display_name: data[0].display_name || ''
          };
        }
      } catch (e) { console.warn('Geocoding failed', e); }
      return null;
    }

    function centerMapOnLocation(lat, lng, showMapPanel) {
      initFarmMapIfNeeded();
      if (!farmMap) return;
      farmMap.setView([lat, lng], LOCATION_MAP_ZOOM);
      setLocationMarker(lat, lng);
      if (showMapPanel) {
        document.getElementById('locationMethodMap').click();
        document.getElementById('locationSummary').textContent = 'Map centered. Draw your farm boundary on the map above.';
        document.getElementById('locationMapHint').classList.remove('hidden');
        setTimeout(function () {
          if (farmMap) farmMap.invalidateSize();
        }, 100);
      }
    }

    document.getElementById('confirmBoundaryBtn').addEventListener('click', function () {
      if (!drawnItems || drawnItems.getLayers().length === 0) {
        document.getElementById('boundaryError').textContent = 'Please draw a polygon on the map first.';
        document.getElementById('boundaryError').classList.remove('hidden');
        return;
      }
      const layer = drawnItems.getLayers()[0];
      const latlngs = layer.getLatLngs()[0];
      if (!latlngs || latlngs.length < 3) {
        document.getElementById('boundaryError').textContent = 'Polygon must have at least 3 points.';
        document.getElementById('boundaryError').classList.remove('hidden');
        return;
      }
      confirmedBoundaryCoords = latlngs.map(function (ll) { return [ll.lat, ll.lng]; });
      document.getElementById('boundaryError').classList.add('hidden');
      document.getElementById('boundarySummary').textContent = 'Boundary confirmed (' + confirmedBoundaryCoords.length + ' points).';
      document.getElementById('clearBoundaryBtn').classList.remove('hidden');
      document.getElementById('savePlaceBtn').disabled = false;
      updateAnalyzeButtonState();
    });

    document.getElementById('clearBoundaryBtn').addEventListener('click', function () {
      if (drawnItems) drawnItems.clearLayers();
      confirmedBoundaryCoords = null;
      document.getElementById('confirmBoundaryBtn').disabled = true;
      document.getElementById('savePlaceBtn').disabled = true;
      document.getElementById('boundarySummary').textContent = '';
      document.getElementById('clearBoundaryBtn').classList.add('hidden');
      document.getElementById('boundaryError').classList.add('hidden');
      updateAnalyzeButtonState();
    });

    // --- Saved places (load / save) ---
    const SAVED_PLACES_KEY = 'agni_saved_places';
    function getSavedPlaces() {
      try {
        return JSON.parse(localStorage.getItem(SAVED_PLACES_KEY) || '[]');
      } catch (e) { return []; }
    }
    function setSavedPlaces(arr) {
      localStorage.setItem(SAVED_PLACES_KEY, JSON.stringify(arr));
    }

    function refreshSavedPlacesDropdown() {
      const list = getSavedPlaces();
      const sel = document.getElementById('loadSavedPlaceSelect');
      if (!sel) return;
      const current = sel.value;
      sel.innerHTML = '<option value="">— Choose one —</option>' +
        list.map((p, i) => '<option value="' + i + '">' + (p.name || 'Saved place ' + (i + 1)) + '</option>').join('');
      if (current !== '' && list[parseInt(current, 10)]) sel.value = current;
      document.getElementById('loadSavedPlaceBtn').disabled = list.length === 0 || sel.value === '';
    }

    function loadSavedPlaceOntoMap(place) {
      if (!place || !place.boundary || place.boundary.length < 3) return;
      initFarmMapIfNeeded();
      if (!farmMap || !drawnItems) return;
      drawnItems.clearLayers();
      const latlngs = place.boundary.map(function (c) { return L.latLng(c[0], c[1]); });
      const polygon = L.polygon(latlngs, { color: '#059669' });
      drawnItems.addLayer(polygon);
      confirmedBoundaryCoords = place.boundary;
      const centerLat = place.boundary.reduce(function (s, c) { return s + c[0]; }, 0) / place.boundary.length;
      const centerLng = place.boundary.reduce(function (s, c) { return s + c[1]; }, 0) / place.boundary.length;
      farmMap.setView([centerLat, centerLng], 14);
      document.getElementById('locationMethodMap').click();
      document.getElementById('boundarySummary').textContent = 'Loaded: ' + (place.name || 'Saved place') + ' (' + place.boundary.length + ' points).';
      document.getElementById('clearBoundaryBtn').classList.remove('hidden');
      document.getElementById('confirmBoundaryBtn').disabled = false;
      document.getElementById('savePlaceBtn').disabled = false;
      document.getElementById('boundaryError').classList.add('hidden');
      updateAnalyzeButtonState();
    }

    document.getElementById('loadSavedPlaceSelect').addEventListener('change', function () {
      document.getElementById('loadSavedPlaceBtn').disabled = this.value === '';
    });
    document.getElementById('loadSavedPlaceBtn').addEventListener('click', function () {
      const idx = document.getElementById('loadSavedPlaceSelect').value;
      if (idx === '') return;
      const list = getSavedPlaces();
      const place = list[parseInt(idx, 10)];
      if (place) loadSavedPlaceOntoMap(place);
    });

    document.getElementById('savePlaceBtn').addEventListener('click', function () {
      if (!confirmedBoundaryCoords || confirmedBoundaryCoords.length < 3) return;
      document.getElementById('savePlaceName').value = '';
      document.getElementById('savePlaceLocation').value = selectedLocationData && selectedLocationData.place ? selectedLocationData.place : '';
      document.getElementById('savePlacePincode').value = selectedLocationData && selectedLocationData.pincode ? selectedLocationData.pincode : '';
      document.getElementById('savePlaceModal').classList.remove('hidden');
    });
    document.getElementById('savePlaceCancelBtn').addEventListener('click', function () {
      document.getElementById('savePlaceModal').classList.add('hidden');
    });
    document.getElementById('savePlaceConfirmBtn').addEventListener('click', function () {
      const name = document.getElementById('savePlaceName').value.trim();
      if (!name) {
        alert('Please enter a place name.');
        return;
      }
      if (!confirmedBoundaryCoords || confirmedBoundaryCoords.length < 3) {
        document.getElementById('savePlaceModal').classList.add('hidden');
        return;
      }
      const list = getSavedPlaces();
      const place = {
        id: Date.now().toString(36) + Math.random().toString(36).slice(2),
        name: name,
        boundary: confirmedBoundaryCoords.map(function (c) { return [c[0], c[1]]; }),
        place: document.getElementById('savePlaceLocation').value.trim(),
        pincode: document.getElementById('savePlacePincode').value.trim(),
        savedAt: new Date().toISOString()
      };
      list.push(place);
      setSavedPlaces(list);
      refreshSavedPlacesDropdown();
      document.getElementById('savePlaceModal').classList.add('hidden');
    });

    document.getElementById('savePlaceFromResultsBtn').addEventListener('click', function () {
      if (!confirmedBoundaryCoords || confirmedBoundaryCoords.length < 3) return;
      document.getElementById('savePlaceName').value = '';
      document.getElementById('savePlaceLocation').value = selectedLocationData && selectedLocationData.place ? selectedLocationData.place : '';
      document.getElementById('savePlacePincode').value = selectedLocationData && selectedLocationData.pincode ? selectedLocationData.pincode : '';
      document.getElementById('savePlaceModal').classList.remove('hidden');
    });

    if (document.getElementById('loadSavedPlaceSelect')) refreshSavedPlacesDropdown();

    // --- Capture map as image (only the polygon boundary area) ---
    document.getElementById('captureMapBtn').addEventListener('click', function () {
      const statusEl = document.getElementById('mapCaptureStatus');
      const errEl = document.getElementById('mapCaptureError');
      const previewEl = document.getElementById('mapCapturePreview');
      const previewImg = document.getElementById('mapCapturePreviewImg');
      const clearBtn = document.getElementById('clearMapCaptureBtn');
      errEl.classList.add('hidden');
      if (!confirmedBoundaryCoords || confirmedBoundaryCoords.length < 3) {
        errEl.textContent = 'Please draw a polygon and click "Confirm Farm Boundary" first.';
        errEl.classList.remove('hidden');
        return;
      }
      if (!farmMap) return;
      statusEl.textContent = 'Capturing boundary area...';
      document.getElementById('captureMapBtn').disabled = true;
      const mapDiv = farmMap.getContainer();
      html2canvas(mapDiv, {
        useCORS: true,
        allowTaint: true,
        logging: false,
        scale: 1
      }).then(function (fullCanvas) {
        // Get polygon bounds in container pixel coordinates
        var minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
        for (var i = 0; i < confirmedBoundaryCoords.length; i++) {
          var pt = L.latLng(confirmedBoundaryCoords[i][0], confirmedBoundaryCoords[i][1]);
          var pixel = farmMap.latLngToContainerPoint(pt);
          minX = Math.min(minX, pixel.x);
          minY = Math.min(minY, pixel.y);
          maxX = Math.max(maxX, pixel.x);
          maxY = Math.max(maxY, pixel.y);
        }
        var pad = 2;
        minX = Math.max(0, Math.floor(minX) - pad);
        minY = Math.max(0, Math.floor(minY) - pad);
        maxX = Math.min(fullCanvas.width, Math.ceil(maxX) + pad);
        maxY = Math.min(fullCanvas.height, Math.ceil(maxY) + pad);
        var w = Math.max(1, maxX - minX);
        var h = Math.max(1, maxY - minY);
        var croppedCanvas = document.createElement('canvas');
        croppedCanvas.width = w;
        croppedCanvas.height = h;
        var ctx = croppedCanvas.getContext('2d');
        ctx.drawImage(fullCanvas, minX, minY, w, h, 0, 0, w, h);
        croppedCanvas.toBlob(function (blob) {
          if (!blob) {
            statusEl.textContent = '';
            errEl.textContent = 'Capture failed. Try again or upload an image.';
            errEl.classList.remove('hidden');
            document.getElementById('captureMapBtn').disabled = false;
            return;
          }
          capturedMapBlob = blob;
          if (previewImg.src) URL.revokeObjectURL(previewImg.src);
          previewImg.src = URL.createObjectURL(blob);
          previewEl.classList.remove('hidden');
          clearBtn.classList.remove('hidden');
          document.getElementById('useBoundaryCheckbox').checked = true;
          statusEl.textContent = 'Boundary area captured. Click "Analyze this image" or "Analyze Image" below.';
          document.getElementById('captureMapBtn').disabled = false;
          updateAnalyzeButtonState();
        }, 'image/png');
      }).catch(function () {
        statusEl.textContent = '';
        errEl.textContent = 'Capture failed (e.g. map tiles). Try uploading an image instead.';
        errEl.classList.remove('hidden');
        document.getElementById('captureMapBtn').disabled = false;
      });
    });

    document.getElementById('analyzeMapCaptureBtn').addEventListener('click', function () {
      if (capturedMapBlob && confirmedBoundaryCoords && confirmedBoundaryCoords.length >= 3) {
        document.getElementById('uploadForm').requestSubmit();
      }
    });

    document.getElementById('clearMapCaptureBtn').addEventListener('click', function () {
      capturedMapBlob = null;
      document.getElementById('mapCapturePreviewImg').src = '';
      document.getElementById('mapCapturePreview').classList.add('hidden');
      document.getElementById('clearMapCaptureBtn').classList.add('hidden');
      document.getElementById('mapCaptureStatus').textContent = '';
      document.getElementById('mapCaptureError').classList.add('hidden');
      updateAnalyzeButtonState();
    });

    document.getElementById('imageFile').addEventListener('change', function () {
      if (this.files.length) {
        capturedMapBlob = null;
        document.getElementById('mapCapturePreview').classList.add('hidden');
        document.getElementById('clearMapCaptureBtn').classList.add('hidden');
        document.getElementById('mapCaptureStatus').textContent = '';
      }
      updateAnalyzeButtonState();
    });

    function updateAnalyzeButtonState() {
      const hasFile = document.getElementById('imageFile').files.length > 0;
      const useBoundary = document.getElementById('useBoundaryCheckbox').checked;
      const analyzeBtn = document.getElementById('analyzeBtn');
      const hintEl = document.getElementById('analyzeHint');
      const hasValidBoundary = confirmedBoundaryCoords && confirmedBoundaryCoords.length >= 3;
      const hasMapCapture = !!capturedMapBlob;
      const canAnalyze = (hasMapCapture && hasValidBoundary) || (hasFile && (!useBoundary || hasValidBoundary));
      analyzeBtn.disabled = !canAnalyze;
      if (canAnalyze) {
        hintEl.textContent = hasMapCapture ? 'Map captured. Click Analyze to run analysis within your boundary.' : (useBoundary ? 'Boundary set. Click Analyze to run analysis within your farm area.' : 'Ready. Click Analyze to run analysis.');
        hintEl.className = 'text-sm text-emerald-600';
      } else if (hasMapCapture && !hasValidBoundary) {
        hintEl.textContent = 'Confirm your boundary to use the captured map.';
        hintEl.className = 'text-sm text-slate-500';
      } else if (useBoundary && !hasValidBoundary) {
        hintEl.textContent = 'Draw a polygon on the map above and click "Confirm Farm Boundary" to enable Analyze.';
        hintEl.className = 'text-sm text-slate-500';
      } else if (!hasFile && !hasMapCapture) {
        hintEl.textContent = 'Capture the map above or select an image file to enable Analyze.';
        hintEl.className = 'text-sm text-slate-500';
      }
    }
    document.getElementById('useBoundaryCheckbox').addEventListener('change', updateAnalyzeButtonState);

    // Login
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      loginError.classList.add('hidden');
      const user = document.getElementById('username').value.trim();
      const pass = document.getElementById('password').value;
      try {
        const res = await fetch(API_BASE + '/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username: user, password: pass }),
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
          loginError.textContent = data.detail || 'Login failed';
          loginError.classList.remove('hidden');
          return;
        }
        token = data.access_token;
        username = user;
        localStorage.setItem('agni_token', token);
        localStorage.setItem('agni_username', username);
        showApp();
      } catch (err) {
        loginError.textContent = 'Network error. Is the backend running at ' + API_BASE + '?';
        loginError.classList.remove('hidden');
      }
    });

    function showApp() {
      loginScreen.classList.add('hidden');
      appLayout.classList.remove('hidden');
      sidebarUsername.textContent = username || 'User';
      document.getElementById('profileUsername').value = username || '';
      updateDashboard();
      fetchHistory();
    }

    function showLogin() {
      loginScreen.classList.remove('hidden');
      appLayout.classList.add('hidden');
      token = null;
      username = null;
      localStorage.removeItem('agni_token');
      localStorage.removeItem('agni_username');
    }

    logoutBtn.addEventListener('click', showLogin);

    // Dashboard functions
    async function updateDashboard() {
      await fetchHistory();
      const history = JSON.parse(localStorage.getItem('agni_history') || '[]');
      document.getElementById('totalAnalyses').textContent = history.length;
      if (history.length > 0) {
        const avgCult = history.reduce((sum, h) => sum + (h.cultivated_percentage || 0), 0) / history.length;
        const avgConf = history.reduce((sum, h) => sum + (h.trust_score || 0), 0) / history.length;
        document.getElementById('avgCultivation').textContent = avgCult.toFixed(1) + '%';
        document.getElementById('avgConfidence').textContent = Math.round(avgConf);
      }
      const judgeCard = document.getElementById('judgeSummaryCard');
      if (judgeCard) {
        if (lastJudgeSummary) {
          judgeCard.classList.remove('hidden');
          document.getElementById('judgeSummaryText').textContent = lastJudgeSummary;
          document.getElementById('judgeSummarySub').textContent = lastJudgeSummarySub || 'From your latest analysis.';
        } else {
          judgeCard.classList.add('hidden');
        }
      }
    }

    async function fetchHistory() {
      if (!token) return;
      try {
        const res = await fetch(API_BASE + '/history', {
          headers: { 'Authorization': 'Bearer ' + token },
        });
        if (res.status === 401) return;
        const list = await res.json().catch(() => []);
        localStorage.setItem('agni_history', JSON.stringify(list));
        const historyList = document.getElementById('historyList');
        if (list.length) {
          historyList.innerHTML = list.slice(0, 5).map(item => {
            const ts = item.timestamp ? new Date(item.timestamp).toLocaleDateString() : '—';
            return `<div class="flex justify-between items-start gap-2 py-2 border-b border-slate-100 last:border-0">
              <div class="flex-1">
                <p class="font-medium text-slate-700">${ts}</p>
                <p class="text-sm text-slate-500">${item.advisory || '—'}</p>
              </div>
              <div class="text-right">
                <p class="font-semibold text-emerald-600">${item.trust_score || '—'}</p>
                <p class="text-xs text-slate-500">${item.cultivated_percentage || 0}%</p>
              </div>
            </div>`;
          }).join('');
        } else {
          historyList.innerHTML = '<p class="text-slate-400 text-sm">No analyses yet.</p>';
        }
      } catch (_) { }
    }

    // Weather functions - Now uses REAL data from backend
    async function fetchWeather(city) {
      // Show loading state
      document.getElementById('weatherLocationName').textContent = 'Loading...';
      document.getElementById('weatherTemp').textContent = '—';
      document.getElementById('weatherDescription').textContent = 'Fetching real weather data...';
      document.getElementById('weatherFeelsLike').textContent = '—';
      document.getElementById('weatherHumidity').textContent = '—';
      document.getElementById('weatherWind').textContent = '—';
      document.getElementById('weatherPressure').textContent = '—';
      document.getElementById('cropConditions').textContent = 'Analyzing...';
      document.getElementById('irrigationAdvice').textContent = 'Analyzing...';
      document.getElementById('fieldWorkAdvice').textContent = 'Analyzing...';

      try {
        // Fetch REAL weather data through our backend (no CORS issues)
        const res = await fetch(`${API_BASE}/weather?city=${encodeURIComponent(city)}`, {
          headers: { 'Authorization': 'Bearer ' + token },
        });

        if (res.status === 401) {
          showLogin();
          return;
        }

        const data = await res.json();

        if (data.success) {
          // Convert backend response to displayWeather format
          const weatherData = {
            name: data.name,
            main: {
              temp: data.temp,
              feels_like: data.feels_like,
              humidity: data.humidity,
              pressure: data.pressure
            },
            weather: [{
              main: data.weather_main,
              description: data.weather_description,
              icon: '01d'
            }],
            wind: {
              speed: data.wind_speed
            }
          };
          displayWeather(weatherData);
        } else {
          throw new Error('Weather API returned error');
        }
      } catch (err) {
        console.error('Weather fetch error:', err);
        // Show error message
        document.getElementById('weatherLocationName').textContent = 'Error';
        document.getElementById('weatherDescription').textContent = 'Failed to fetch weather data. Please try again.';
        document.getElementById('cropConditions').textContent = 'Unable to analyze - weather data unavailable';
        document.getElementById('irrigationAdvice').textContent = 'Unable to provide advice - weather data unavailable';
        document.getElementById('fieldWorkAdvice').textContent = 'Unable to provide advice - weather data unavailable';
      }
    }

    function displayWeather(data) {
      document.getElementById('weatherLocationName').textContent = data.name;
      document.getElementById('weatherTemp').textContent = Math.round(data.main.temp) + '°C';
      document.getElementById('weatherDescription').textContent = data.weather[0].description;
      document.getElementById('weatherFeelsLike').textContent = Math.round(data.main.feels_like) + '°C';
      document.getElementById('weatherHumidity').textContent = data.main.humidity + '%';
      document.getElementById('weatherWind').textContent = data.wind.speed + ' m/s';
      document.getElementById('weatherPressure').textContent = data.main.pressure + ' hPa';

      // Agricultural impact
      const temp = data.main.temp;
      const humidity = data.main.humidity;
      const conditions = data.weather[0].main;

      let cropCond = 'Good conditions for crop growth.';
      if (temp < 10) cropCond = 'Cold conditions. Protect sensitive crops.';
      else if (temp > 35) cropCond = 'Hot conditions. Ensure adequate irrigation.';

      let irrigAdvice = 'Normal irrigation schedule recommended.';
      if (humidity < 40) irrigAdvice = 'Low humidity. Increase irrigation frequency.';
      else if (humidity > 80) irrigAdvice = 'High humidity. Reduce irrigation to prevent disease.';

      let fieldWork = 'Suitable conditions for field work.';
      if (conditions === 'Rain') fieldWork = 'Avoid field work due to rain.';
      else if (conditions === 'Storm') fieldWork = 'Dangerous conditions. Stay indoors.';

      document.getElementById('cropConditions').textContent = cropCond;
      document.getElementById('irrigationAdvice').textContent = irrigAdvice;
      document.getElementById('fieldWorkAdvice').textContent = fieldWork;
    }

    // Location method toggle (Map vs Pincode/Place)
    let currentLocationMethod = 'map';
    let selectedLocationData = null;
    
    document.getElementById('locationMethodMap').addEventListener('click', () => {
      currentLocationMethod = 'map';
      document.getElementById('locationMethodMap').classList.add('border-emerald-600', 'bg-emerald-50', 'text-emerald-700');
      document.getElementById('locationMethodMap').classList.remove('border-slate-300', 'bg-white', 'text-slate-700');
      document.getElementById('locationMethodPincode').classList.remove('border-emerald-600', 'bg-emerald-50', 'text-emerald-700');
      document.getElementById('locationMethodPincode').classList.add('border-slate-300', 'bg-white', 'text-slate-700');
      document.getElementById('locationMethodMapPanel').classList.remove('hidden');
      document.getElementById('locationMethodPincodePanel').classList.add('hidden');
      document.getElementById('locationMapHint').classList.add('hidden');
      initFarmMapIfNeeded();
    });
    
    document.getElementById('locationMethodPincode').addEventListener('click', () => {
      currentLocationMethod = 'pincode';
      document.getElementById('locationMethodPincode').classList.add('border-emerald-600', 'bg-emerald-50', 'text-emerald-700');
      document.getElementById('locationMethodPincode').classList.remove('border-slate-300', 'bg-white', 'text-slate-700');
      document.getElementById('locationMethodMap').classList.remove('border-emerald-600', 'bg-emerald-50', 'text-emerald-700');
      document.getElementById('locationMethodMap').classList.add('border-slate-300', 'bg-white', 'text-slate-700');
      document.getElementById('locationMethodPincodePanel').classList.remove('hidden');
      document.getElementById('locationMethodMapPanel').classList.add('hidden');
    });
    
    document.getElementById('confirmLocationBtn').addEventListener('click', async () => {
      const pincode = document.getElementById('farmPincode').value.trim();
      const place = document.getElementById('farmPlace').value.trim();
      const query = place || pincode;
      if (!query) {
        document.getElementById('locationError').textContent = 'Please enter pincode or place name.';
        document.getElementById('locationError').classList.remove('hidden');
        return;
      }
      document.getElementById('locationError').classList.add('hidden');
      document.getElementById('locationSummary').textContent = 'Finding location...';
      const result = await geocodePincodeOrPlace(query);
      if (!result) {
        document.getElementById('locationError').textContent = 'Could not find that place. Try a different pincode or name.';
        document.getElementById('locationError').classList.remove('hidden');
        document.getElementById('locationSummary').textContent = '';
        return;
      }
      selectedLocationData = { pincode, place, method: 'pincode', lat: result.lat, lon: result.lon };
      document.getElementById('locationSummary').textContent = result.display_name ? `Found: ${result.display_name}` : '';
      centerMapOnLocation(result.lat, result.lon, true);
    });

    document.getElementById('useCurrentLocationBtn').addEventListener('click', () => {
      document.getElementById('locationError').classList.add('hidden');
      if (!navigator.geolocation) {
        document.getElementById('locationError').textContent = 'Geolocation is not supported by your browser.';
        document.getElementById('locationError').classList.remove('hidden');
        return;
      }
      document.getElementById('locationSummary').textContent = 'Getting your location...';
      navigator.geolocation.getCurrentPosition(
        function (pos) {
          const lat = pos.coords.latitude;
          const lng = pos.coords.longitude;
          selectedLocationData = { method: 'current', lat, lon: lng };
          document.getElementById('locationSummary').textContent = 'Current location set.';
          centerMapOnLocation(lat, lng, true);
        },
        function () {
          document.getElementById('locationError').textContent = 'Could not get your location. Check permissions or try pincode/place.';
          document.getElementById('locationError').classList.remove('hidden');
          document.getElementById('locationSummary').textContent = '';
        }
      );
    });

    // Weather: Use geolocation by default
    let userLocation = null;
    
    async function fetchWeatherByLocation() {
      if (!userLocation) {
        if (navigator.geolocation) {
          document.getElementById('weatherLocationStatus').textContent = 'Getting your location...';
          navigator.geolocation.getCurrentPosition(
            async (position) => {
              userLocation = {
                lat: position.coords.latitude,
                lon: position.coords.longitude
              };
              try {
                const res = await fetch(`${API_BASE}/weather-by-coords?lat=${userLocation.lat}&lon=${userLocation.lon}`, {
                  headers: { 'Authorization': 'Bearer ' + token }
                });
                if (res.status === 401) { showLogin(); return; }
                const data = await res.json();
                if (data.success) {
                  const weatherData = {
                    name: data.name + (data.country ? ', ' + data.country : ''),
                    main: {
                      temp: data.temp,
                      feels_like: data.feels_like,
                      humidity: data.humidity,
                      pressure: data.pressure
                    },
                    weather: [{
                      main: data.weather_main,
                      description: data.weather_description,
                      icon: '01d'
                    }],
                    wind: {
                      speed: data.wind_speed
                    }
                  };
                  displayWeather(weatherData);
                  document.getElementById('weatherLocationStatus').textContent = `Showing weather for: ${data.name || 'Your location'}`;
                }
              } catch (err) {
                document.getElementById('weatherLocationStatus').textContent = 'Could not fetch weather. Try searching for a city.';
                fetchWeather('Delhi');
              }
            },
            () => {
              document.getElementById('weatherLocationStatus').textContent = 'Location access denied. Using default location.';
              fetchWeather('Delhi');
            }
          );
        } else {
          fetchWeather('Delhi');
        }
      } else {
        try {
          const res = await fetch(`${API_BASE}/weather-by-coords?lat=${userLocation.lat}&lon=${userLocation.lon}`, {
            headers: { 'Authorization': 'Bearer ' + token }
          });
          if (res.status === 401) { showLogin(); return; }
          const data = await res.json();
          if (data.success) {
            const weatherData = {
              name: data.name + (data.country ? ', ' + data.country : ''),
              main: {
                temp: data.temp,
                feels_like: data.feels_like,
                humidity: data.humidity,
                pressure: data.pressure
              },
              weather: [{
                main: data.weather_main,
                description: data.weather_description,
                icon: '01d'
              }],
              wind: {
                speed: data.wind_speed
              }
            };
            displayWeather(weatherData);
            document.getElementById('weatherLocationStatus').textContent = `Showing weather for: ${data.name || 'Your location'}`;
          }
        } catch (err) {
          fetchWeather('Delhi');
        }
      }
    }
    
    document.getElementById('useMyLocationBtn').addEventListener('click', () => {
      userLocation = null;
      fetchWeatherByLocation();
    });
    
    document.getElementById('fetchWeatherBtn').addEventListener('click', () => {
      const city = document.getElementById('weatherLocation').value.trim();
      if (city) {
        fetchWeather(city);
        document.getElementById('weatherLocationStatus').textContent = '';
      }
    });

    // My Lands Management (includes both manual lands and saved analyzed places)
    let myLands = JSON.parse(localStorage.getItem('agni_lands') || '[]');
    
    function getSavedPlacesForLands() {
      try {
        return JSON.parse(localStorage.getItem('agni_saved_places') || '[]');
      } catch (e) { return []; }
    }
    
    function loadMyLands() {
      const landsList = document.getElementById('landsList');
      const savedPlaces = getSavedPlacesForLands();
      const items = [];
      myLands.forEach((land, idx) => {
        items.push({ type: 'land', index: idx, name: land.name, place: land.place || '', pincode: land.pincode || '', notes: land.notes, useFingerprint: land.useFingerprint });
      });
      savedPlaces.forEach((place, idx) => {
        items.push({ type: 'saved_place', index: idx, name: place.name || ('Saved place ' + (idx + 1)), place: place.place || '', pincode: place.pincode || '', boundary: place.boundary });
      });
      if (items.length === 0) {
        landsList.innerHTML = '<p class="text-slate-400 text-sm text-center py-8">No lands saved yet. Click "Add New Land" or save a place from Image Analyzer.</p>';
        return;
      }
      landsList.innerHTML = items.map((item, i) => {
        const isPlace = item.type === 'saved_place';
        const editDel = item.type === 'land' ? `
          <button onclick="editLand(${item.index})" class="px-3 py-1 text-sm bg-blue-50 text-blue-700 rounded hover:bg-blue-100">
            <i class="fas fa-edit"></i>
          </button>
          <button onclick="deleteLand(${item.index})" class="px-3 py-1 text-sm bg-red-50 text-red-700 rounded hover:bg-red-100">
            <i class="fas fa-trash"></i>
          </button>
        ` : `
          <button onclick="deleteSavedPlace(${item.index})" class="px-3 py-1 text-sm bg-red-50 text-red-700 rounded hover:bg-red-100">
            <i class="fas fa-trash"></i>
          </button>
        `;
        return `
        <div class="border border-slate-200 rounded-lg p-4 hover:shadow-md transition cursor-pointer land-detail-card" data-type="${item.type}" data-index="${item.index}">
          <div class="flex items-start justify-between">
            <div class="flex-1">
              <h4 class="font-semibold text-slate-800 flex items-center gap-2">
                ${item.name}
                ${isPlace ? '<span class="text-xs bg-emerald-100 text-emerald-700 px-2 py-0.5 rounded">Analyzed</span>' : ''}
                ${item.useFingerprint ? '<i class="fas fa-fingerprint text-emerald-600 text-sm" title="Fingerprint protected"></i>' : ''}
              </h4>
              <p class="text-sm text-slate-600 mt-1">
                <i class="fas fa-map-pin mr-1"></i>${item.place || '—'}${item.pincode ? ' (' + item.pincode + ')' : ''}
              </p>
              ${item.notes ? `<p class="text-sm text-slate-500 mt-2">${item.notes}</p>` : ''}
              <p class="text-xs text-emerald-600 mt-2">Click to see current weather &amp; crop analysis</p>
            </div>
            <div class="flex gap-2" onclick="event.stopPropagation();">
              ${isPlace ? `<button onclick="openInAnalyzer(${item.index})" class="px-3 py-1 text-sm bg-emerald-50 text-emerald-700 rounded hover:bg-emerald-100"><i class="fas fa-map mr-1"></i>Open in Analyzer</button>` : ''}
              ${editDel}
            </div>
          </div>
        </div>
      `;
      }).join('');
      landsList.querySelectorAll('.land-detail-card').forEach(el => {
        el.addEventListener('click', function () {
          const type = this.getAttribute('data-type');
          const index = parseInt(this.getAttribute('data-index'), 10);
          if (type && !isNaN(index)) openLandDetail(type, index);
        });
      });
    }
    
    window.deleteSavedPlace = function(idx) {
      const list = getSavedPlacesForLands();
      list.splice(idx, 1);
      localStorage.setItem('agni_saved_places', JSON.stringify(list));
      loadMyLands();
      if (typeof refreshSavedPlacesDropdown === 'function') refreshSavedPlacesDropdown();
    };
    
    window.openInAnalyzer = function(savedPlaceIndex) {
      const list = getSavedPlacesForLands();
      const place = list[savedPlaceIndex];
      if (!place || !place.boundary) return;
      if (typeof loadSavedPlaceOntoMap === 'function') {
        navigateToPage('analyzer');
        setTimeout(function() { loadSavedPlaceOntoMap(place); }, 300);
      } else {
        navigateToPage('analyzer');
      }
    };
    
    async function openLandDetail(type, index) {
      const modal = document.getElementById('landDetailModal');
      const loading = document.getElementById('landDetailLoading');
      const content = document.getElementById('landDetailContent');
      const nameEl = document.getElementById('landDetailName');
      const locationEl = document.getElementById('landDetailLocation');
      const openAnalyzerBtn = document.getElementById('landDetailOpenAnalyzerBtn');
      modal.classList.remove('hidden');
      loading.classList.remove('hidden');
      content.classList.add('hidden');
      openAnalyzerBtn.classList.add('hidden');
      
      let name = '', place = '', pincode = '', lat = null, lon = null;
      if (type === 'land') {
        const land = myLands[index];
        name = land.name;
        place = land.place || '';
        pincode = land.pincode || '';
        const query = place || pincode || name;
        if (query && typeof geocodePincodeOrPlace === 'function') {
          const res = await geocodePincodeOrPlace(query);
          if (res) { lat = res.lat; lon = res.lon; }
        }
      } else {
        const list = getSavedPlacesForLands();
        const p = list[index];
        name = p.name || 'Saved place';
        place = p.place || '';
        pincode = p.pincode || '';
        if (p.boundary && p.boundary.length >= 3) {
          lat = p.boundary.reduce((s, c) => s + c[0], 0) / p.boundary.length;
          lon = p.boundary.reduce((s, c) => s + c[1], 0) / p.boundary.length;
        }
        openAnalyzerBtn.classList.remove('hidden');
        openAnalyzerBtn.onclick = function() { openInAnalyzer(index); };
      }
      
      nameEl.textContent = name;
      locationEl.textContent = [place, pincode].filter(Boolean).join(' · ') || '—';
      
      if (!token) { loading.textContent = 'Please log in.'; return; }
      try {
        let weatherData = null;
        if (lat != null && lon != null) {
          const wRes = await fetch(`${API_BASE}/weather-by-coords?lat=${lat}&lon=${lon}`, { headers: { 'Authorization': 'Bearer ' + token } });
          if (wRes.ok) weatherData = await wRes.json();
        }
        if (!weatherData && (place || name)) {
          const city = place || name;
          const wRes = await fetch(`${API_BASE}/weather?city=${encodeURIComponent(city)}`, { headers: { 'Authorization': 'Bearer ' + token } });
          if (wRes.ok) weatherData = await wRes.json();
        }
        if (!weatherData || !weatherData.success) {
          document.getElementById('landDetailWeatherTemp').textContent = '—';
          document.getElementById('landDetailWeatherDesc').textContent = 'Weather unavailable.';
          document.getElementById('landDetailWeatherExtra').textContent = '';
        } else {
          document.getElementById('landDetailWeatherTemp').textContent = (weatherData.temp != null ? Math.round(weatherData.temp) + '°C' : '—');
          document.getElementById('landDetailWeatherDesc').textContent = (weatherData.weather_description || weatherData.name || '—');
          document.getElementById('landDetailWeatherExtra').textContent = [
            weatherData.name ? '📍 ' + weatherData.name : '',
            weatherData.humidity != null ? 'Humidity ' + weatherData.humidity + '%' : '',
            weatherData.wind_speed != null ? 'Wind ' + weatherData.wind_speed + ' m/s' : ''
          ].filter(Boolean).join('  ·  ');
        }
        
        const temp = weatherData && weatherData.temp != null ? weatherData.temp : 25;
        const humidity = weatherData && weatherData.humidity != null ? weatherData.humidity : 60;
        const cropLat = lat != null ? lat : 20.5937;
        const cropLon = lon != null ? lon : 78.9629;
        const cropRes = await fetch(`${API_BASE}/recommend-crops?temp=${temp}&humidity=${humidity}&lat=${cropLat}&cultivated_pct=50&water_pct=5&farmable_space_pct=50`, { headers: { 'Authorization': 'Bearer ' + token } });
        if (cropRes.ok) {
          const cropData = await cropRes.json();
          document.getElementById('landDetailCropsSummary').textContent = cropData.summary || '—';
          if (cropData.primary_crop) {
            const c = cropData.primary_crop;
            document.getElementById('landDetailCropsPrimary').innerHTML = `<strong>${c.emoji} ${c.name}</strong> (${c.match_pct || 0}% match) · ${c.category} · ${c.duration}`;
          } else {
            document.getElementById('landDetailCropsPrimary').innerHTML = '—';
          }
          const sub = (cropData.sub_suggestions || []).slice(0, 5).map(c => `${c.emoji} ${c.name} (${c.match_pct}%)`).join(', ');
          document.getElementById('landDetailCropsSub').textContent = sub ? 'Also consider: ' + sub : '';
        } else {
          document.getElementById('landDetailCropsSummary').textContent = 'Crop recommendations unavailable.';
          document.getElementById('landDetailCropsPrimary').innerHTML = '';
          document.getElementById('landDetailCropsSub').textContent = '';
        }
      } catch (e) {
        document.getElementById('landDetailWeatherTemp').textContent = '—';
        document.getElementById('landDetailWeatherDesc').textContent = 'Could not load data.';
        document.getElementById('landDetailWeatherExtra').textContent = '';
        document.getElementById('landDetailCropsSummary').textContent = 'Could not load crop recommendations.';
        document.getElementById('landDetailCropsPrimary').innerHTML = '';
        document.getElementById('landDetailCropsSub').textContent = '';
      }
      loading.classList.add('hidden');
      content.classList.remove('hidden');
    }
    
    document.getElementById('closeLandDetailModal').addEventListener('click', function() {
      document.getElementById('landDetailModal').classList.add('hidden');
    });
    document.getElementById('closeLandDetailModalBtn').addEventListener('click', function() {
      document.getElementById('landDetailModal').classList.add('hidden');
    });
    
    window.editLand = function(idx) {
      const land = myLands[idx];
      document.getElementById('landId').value = idx;
      document.getElementById('landName').value = land.name;
      document.getElementById('landPincode').value = land.pincode || '';
      document.getElementById('landPlace').value = land.place || '';
      document.getElementById('landNotes').value = land.notes || '';
      document.getElementById('landUseFingerprint').checked = land.useFingerprint || false;
      document.getElementById('landModalTitle').textContent = 'Edit Land';
      document.getElementById('landModal').classList.remove('hidden');
    };
    
    window.deleteLand = function(idx) {
      if (confirm('Are you sure you want to delete this land?')) {
        myLands.splice(idx, 1);
        localStorage.setItem('agni_lands', JSON.stringify(myLands));
        loadMyLands();
      }
    };
    
    document.getElementById('addLandBtn').addEventListener('click', () => {
      document.getElementById('landId').value = '';
      document.getElementById('landForm').reset();
      document.getElementById('landModalTitle').textContent = 'Add New Land';
      document.getElementById('landModal').classList.remove('hidden');
    });
    
    document.getElementById('closeLandModal').addEventListener('click', () => {
      document.getElementById('landModal').classList.add('hidden');
    });
    
    document.getElementById('cancelLandForm').addEventListener('click', () => {
      document.getElementById('landModal').classList.add('hidden');
    });
    
    document.getElementById('landForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const idx = document.getElementById('landId').value;
      const land = {
        name: document.getElementById('landName').value,
        pincode: document.getElementById('landPincode').value.trim(),
        place: document.getElementById('landPlace').value.trim(),
        notes: document.getElementById('landNotes').value.trim(),
        useFingerprint: document.getElementById('landUseFingerprint').checked,
        createdAt: new Date().toISOString()
      };
      if (idx === '') {
        myLands.push(land);
      } else {
        myLands[parseInt(idx)] = land;
      }
      localStorage.setItem('agni_lands', JSON.stringify(myLands));
      loadMyLands();
      document.getElementById('landModal').classList.add('hidden');
    });

    // News functions
    async function fetchNews() {
      const newsList = document.getElementById('newsList');
      // Use believable fake agricultural news
      const fakeNews = [
        {
          title: 'New Sustainable Farming Techniques Show Promise',
          summary: 'Researchers have developed innovative methods to increase crop yield while reducing water usage.',
          date: '2 days ago',
          category: 'Research'
        },
        {
          title: 'Weather Patterns Favor Spring Planting Season',
          summary: 'Meteorologists predict favorable conditions for the upcoming planting season across major agricultural regions.',
          date: '3 days ago',
          category: 'Weather'
        },
        {
          title: 'Organic Farming Gains Traction in Rural Communities',
          summary: 'More farmers are adopting organic practices due to increasing consumer demand and government incentives.',
          date: '5 days ago',
          category: 'Trends'
        },
        {
          title: 'Smart Irrigation Systems Reduce Water Waste by 40%',
          summary: 'New IoT-based irrigation technology helps farmers optimize water usage and improve crop health.',
          date: '1 week ago',
          category: 'Technology'
        }
      ];

      newsList.innerHTML = fakeNews.map(news => `
        <div class="border border-slate-200 rounded-lg p-4 hover:shadow-md transition">
          <div class="flex items-start justify-between mb-2">
            <span class="text-xs px-2 py-1 bg-emerald-100 text-emerald-700 rounded">${news.category}</span>
            <span class="text-xs text-slate-500">${news.date}</span>
          </div>
          <h4 class="font-semibold text-slate-800 mb-2">${news.title}</h4>
          <p class="text-sm text-slate-600">${news.summary}</p>
        </div>
      `).join('');
    }

    // Image Analyzer (existing code adapted)
    const uploadForm = document.getElementById('uploadForm');
    const analyzeBtn = document.getElementById('analyzeBtn');
    const resultsCard = document.getElementById('resultsCard');
    const analyzeBtnText = document.getElementById('analyzeBtnText');
    const analyzeSpinner = document.getElementById('analyzeSpinner');
    const explanationToggle = document.getElementById('explanationToggle');
    const explanationSection = document.getElementById('explanationSection');
    const explanationToggleIcon = document.getElementById('explanationToggleIcon');
    const lowConfidenceWarning = document.getElementById('lowConfidenceWarning');

    // Demo mode: try with sample image (no upload — great for judges)
    document.getElementById('trySampleImageBtn')?.addEventListener('click', async () => {
      document.getElementById('trySampleImageBtn').disabled = true;
      document.getElementById('trySampleImageBtn').innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Loading...';
      try {
        const imgRes = await fetch(API_BASE + '/demo-image');
        if (!imgRes.ok) throw new Error('Could not load sample image');
        const blob = await imgRes.blob();
        const formData = new FormData();
        formData.append('file', blob, 'sample_field.jpg');
        const res = await fetch(API_BASE + '/analyze', {
          method: 'POST',
          headers: { 'Authorization': 'Bearer ' + token },
          body: formData,
        });
        const data = await res.json().catch(() => ({}));
        if (res.status === 401) { showLogin(); return; }
        if (!res.ok) { alert(data.detail || 'Analysis failed'); return; }
        try {
        const uploadErrorEl = document.getElementById('uploadError');
        if (uploadErrorEl) uploadErrorEl.classList.add('hidden');
        const withinBoundaryMsg = document.getElementById('withinBoundaryMessage');
        const savePlaceResultRow = document.getElementById('savePlaceResultRow');
        if (withinBoundaryMsg) withinBoundaryMsg.classList.add('hidden');
        if (savePlaceResultRow) savePlaceResultRow.classList.add('hidden');
        const setText = (id, text) => { const el = document.getElementById(id); if (el) el.textContent = text; };
        setText('cultivatedPct', data.cultivated_percentage + '%');
        setText('stressPct', data.stress_percentage + '%');
        setText('trustScore', data.trust_score);
        setText('classificationResult', data.classification || '—');
        setText('advisory', data.advisory || '—');
        setText('totalPixels', (data.total_pixels || 0).toLocaleString());
        setText('cultivatedPixels', (data.cultivated_pixels || 0).toLocaleString());
        setText('nonCultivatedPixels', (data.non_cultivated_pixels || 0).toLocaleString());
        setText('coverageRatio', ((data.coverage_ratio || 0) * 100).toFixed(2) + '%');
        const binaryMaskPreview = document.getElementById('binaryMaskPreview');
        const overlayMaskPreview = document.getElementById('overlayMaskPreview');
        const landUseMaskPreview = document.getElementById('landUseMaskPreview');
        const segmentationPreview = document.getElementById('segmentationPreview');
        if (data.binary_mask_base64 && binaryMaskPreview) {
          binaryMaskPreview.src = 'data:image/png;base64,' + data.binary_mask_base64;
          binaryMaskPreview.classList.remove('hidden');
          const ph = document.getElementById('binaryMaskPlaceholder');
          if (ph) ph.classList.add('hidden');
        }
        if (data.overlay_mask_base64 && overlayMaskPreview) {
          overlayMaskPreview.src = 'data:image/png;base64,' + data.overlay_mask_base64;
          overlayMaskPreview.classList.remove('hidden');
          const ph = document.getElementById('overlayMaskPlaceholder');
          if (ph) ph.classList.add('hidden');
        }
        if (data.land_use_mask_base64 && landUseMaskPreview) {
          landUseMaskPreview.src = 'data:image/png;base64,' + data.land_use_mask_base64;
          landUseMaskPreview.classList.remove('hidden');
          const ph = document.getElementById('landUseMaskPlaceholder');
          if (ph) ph.classList.add('hidden');
        }
        if (data.segmentation_image_base64 && segmentationPreview) {
          segmentationPreview.src = 'data:image/png;base64,' + data.segmentation_image_base64;
        }
        if (data.water_percentage !== undefined && typeof displayLandUseBreakdown === 'function') {
          const section = document.getElementById('landUseBreakdown');
          if (section) displayLandUseBreakdown(data);
        }
        const resultsCard = document.getElementById('resultsCard');
        if (resultsCard) resultsCard.classList.remove('hidden');
        fetchHistory();
        updateDashboard();
        fetchWeatherAndRecommendCrops(data);
        const analyzeHint = document.getElementById('analyzeHint');
        if (analyzeHint) analyzeHint.textContent = 'Demo completed. You can upload your own image next.';
        } catch (displayErr) {
          console.error('Demo display error:', displayErr);
          const rc = document.getElementById('resultsCard');
          if (rc) rc.classList.remove('hidden');
          const cp = document.getElementById('cultivatedPct');
          if (cp) cp.textContent = (data.cultivated_percentage != null ? data.cultivated_percentage + '%' : '—');
          const adv = document.getElementById('advisory');
          if (adv) adv.textContent = data.advisory || '—';
          if (typeof fetchWeatherAndRecommendCrops === 'function') fetchWeatherAndRecommendCrops(data);
        }
      } catch (err) {
        alert('Demo failed. Is the backend running? ' + (err.message || ''));
      } finally {
        document.getElementById('trySampleImageBtn').disabled = false;
        document.getElementById('trySampleImageBtn').innerHTML = '<i class="fas fa-magic mr-2"></i>Try with sample image';
      }
    });

    uploadForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const fileInput = document.getElementById('imageFile');
      const useBoundaryCheckbox = document.getElementById('useBoundaryCheckbox');
      const uploadError = document.getElementById('uploadError');
      const useMapImage = !!capturedMapBlob;

      if (!useMapImage && !fileInput.files.length) {
        uploadError.textContent = 'Capture the map above or select an image file.';
        uploadError.classList.remove('hidden');
        return;
      }
      if (useMapImage && (!confirmedBoundaryCoords || confirmedBoundaryCoords.length < 3)) {
        uploadError.textContent = 'When using map capture, a boundary must be drawn and confirmed.';
        uploadError.classList.remove('hidden');
        return;
      }
      if (!useMapImage && useBoundaryCheckbox.checked && (!confirmedBoundaryCoords || confirmedBoundaryCoords.length < 3)) {
        uploadError.textContent = 'Please draw and confirm a farm boundary (at least 3 points) on the map.';
        uploadError.classList.remove('hidden');
        return;
      }
      uploadError.classList.add('hidden');

      const formData = new FormData();
      if (useMapImage) {
        formData.append('file', capturedMapBlob, 'map-capture.png');
        formData.append('boundary', JSON.stringify(confirmedBoundaryCoords));
      } else {
        formData.append('file', fileInput.files[0]);
        if (useBoundaryCheckbox.checked && confirmedBoundaryCoords && confirmedBoundaryCoords.length >= 3) {
          formData.append('boundary', JSON.stringify(confirmedBoundaryCoords));
        }
      }
      document.getElementById('analyzeBtn').disabled = true;
      analyzeBtnText.classList.add('hidden');
      analyzeSpinner.classList.remove('hidden');

      try {
        const res = await fetch(API_BASE + '/analyze', {
          method: 'POST',
          headers: { 'Authorization': 'Bearer ' + token },
          body: formData,
        });
        const data = await res.json().catch(() => ({}));
        if (res.status === 401) {
          showLogin();
          return;
        }
        if (!res.ok) {
          alert(data.detail || 'Analysis failed');
          return;
        }

        // Display results
        if (data.within_boundary) {
          document.getElementById('withinBoundaryMessage').classList.remove('hidden');
          document.getElementById('savePlaceResultRow').classList.remove('hidden');
        } else {
          document.getElementById('withinBoundaryMessage').classList.add('hidden');
          document.getElementById('savePlaceResultRow').classList.add('hidden');
        }
        document.getElementById('cultivatedPct').textContent = data.cultivated_percentage + '%';
        document.getElementById('stressPct').textContent = data.stress_percentage + '%';
        document.getElementById('trustScore').textContent = data.trust_score;
        document.getElementById('classificationResult').textContent = data.classification || '—';
        document.getElementById('advisory').textContent = data.advisory || '—';
        const boundarySection = document.getElementById('boundaryPortionStats');
        const totalPixelsLabel = document.getElementById('totalPixelsLabel');
        if (data.within_boundary && data.full_image_pixels != null) {
          if (boundarySection) boundarySection.classList.remove('hidden');
          const fp = document.getElementById('fullImagePixels');
          if (fp) fp.textContent = (data.full_image_pixels || 0).toLocaleString() + ' px';
          const ip = document.getElementById('insideBoundaryPct');
          if (ip) ip.textContent = (data.percentage_inside_boundary ?? 0) + '% (' + (data.pixels_inside_boundary || 0).toLocaleString() + ' px)';
          const op = document.getElementById('outsideBoundaryPct');
          if (op) op.textContent = (data.percentage_outside_boundary ?? 0) + '% (' + (data.pixels_outside_boundary || 0).toLocaleString() + ' px)';
          if (totalPixelsLabel) totalPixelsLabel.textContent = '(in selected region)';
        } else {
          if (boundarySection) boundarySection.classList.add('hidden');
          if (totalPixelsLabel) totalPixelsLabel.textContent = '';
        }
        document.getElementById('totalPixels').textContent = (data.total_pixels || 0).toLocaleString();
        document.getElementById('cultivatedPixels').textContent = (data.cultivated_pixels || 0).toLocaleString();
        document.getElementById('nonCultivatedPixels').textContent = (data.non_cultivated_pixels || 0).toLocaleString();
        document.getElementById('coverageRatio').textContent = ((data.coverage_ratio || 0) * 100).toFixed(2) + '%';

        const binPreview = document.getElementById('binaryMaskPreview');
        const ovPreview = document.getElementById('overlayMaskPreview');
        const landPreview = document.getElementById('landUseMaskPreview');
        const segPreview = document.getElementById('segmentationPreview');
        if (data.binary_mask_base64 && binPreview) {
          binPreview.src = 'data:image/png;base64,' + data.binary_mask_base64;
          binPreview.classList.remove('hidden');
          const ph = document.getElementById('binaryMaskPlaceholder');
          if (ph) ph.classList.add('hidden');
        }
        if (data.overlay_mask_base64 && ovPreview) {
          ovPreview.src = 'data:image/png;base64,' + data.overlay_mask_base64;
          ovPreview.classList.remove('hidden');
          const ph = document.getElementById('overlayMaskPlaceholder');
          if (ph) ph.classList.add('hidden');
        }
        if (data.land_use_mask_base64 && landPreview) {
          landPreview.src = 'data:image/png;base64,' + data.land_use_mask_base64;
          landPreview.classList.remove('hidden');
          const ph = document.getElementById('landUseMaskPlaceholder');
          if (ph) ph.classList.add('hidden');
        }
        if (data.segmentation_image_base64 && segPreview) {
          segPreview.src = 'data:image/png;base64,' + data.segmentation_image_base64;
        }

        var imageBlob = capturedMapBlob || (fileInput.files.length ? fileInput.files[0] : null);
        if (imageBlob) {
          var fileUrl = URL.createObjectURL(imageBlob);
          const origPreview = document.getElementById('originalPreview');
          if (origPreview) {
            origPreview.src = fileUrl;
            origPreview.classList.remove('hidden');
          }
          const origPh = document.getElementById('originalPlaceholder');
          if (origPh) origPh.classList.add('hidden');
        }

        if (data.trust_score < 60) {
          lowConfidenceWarning.classList.remove('hidden');
        } else {
          lowConfidenceWarning.classList.add('hidden');
        }

        // --- Display Land Use Breakdown ---
        if (data.water_percentage !== undefined) {
          displayLandUseBreakdown(data);
        }

        resultsCard.classList.remove('hidden');
        fetchHistory();
        updateDashboard();

        // --- Auto-fetch weather + crop recommendations ---
        fetchWeatherAndRecommendCrops(data);
      } catch (err) {
        alert('Network error. Is the backend running?');
      } finally {
        document.getElementById('analyzeBtn').disabled = false;
        analyzeBtnText.classList.remove('hidden');
        analyzeSpinner.classList.add('hidden');
      }
    });

    explanationToggle.addEventListener('click', () => {
      const isHidden = explanationSection.classList.contains('hidden');
      explanationSection.classList.toggle('hidden');
      explanationToggleIcon.textContent = isHidden ? '▲' : '▼';
    });

    // Download / Print report (one-page summary for judges or farmers)
    document.getElementById('downloadReportBtn')?.addEventListener('click', () => {
      if (!lastAnalysisData) {
        alert('Run an analysis first to generate a report.');
        return;
      }
      const d = lastAnalysisData;
      const crop = lastCropData;
      const date = new Date().toLocaleString();
      const html = `
<!DOCTYPE html>
<html><head><meta charset="utf-8"><title>AGNI – Field Report</title>
<style>body{font-family:system-ui,sans-serif;max-width:700px;margin:2rem auto;padding:1rem;color:#1e293b;}
h1{color:#047857;font-size:1.5rem;} .section{margin:1.5rem 0;} .row{display:flex;justify-content:space-between;margin:0.25rem 0;}
.badge{background:#d1fae5;color:#065f46;padding:0.25rem 0.5rem;border-radius:0.5rem;font-weight:600;}
.crop{background:#f0fdf4;border:1px solid #86efac;padding:0.75rem;border-radius:0.5rem;margin:0.5rem 0;}
@media print{body{margin:0.5rem;}</style></head>
<body>
<h1>AGNI – Field Analysis Report</h1>
<p class="section"><strong>Generated:</strong> ${date}</p>
<div class="section">
  <h2 style="font-size:1.1rem;">Summary</h2>
  <p><span class="badge">Cultivated ${d.cultivated_percentage}%</span> &nbsp; Stress ${d.stress_percentage}% &nbsp; Confidence ${d.trust_score}</p>
  <p><strong>Classification:</strong> ${d.classification || '—'}</p>
  <p><strong>Advisory:</strong> ${d.advisory || '—'}</p>
</div>
<div class="section">
  <h2 style="font-size:1.1rem;">Land use</h2>
  <div class="row"><span>Vegetation</span><span>${d.vegetation_percentage ?? 0}%</span></div>
  <div class="row"><span>Water</span><span>${d.water_percentage ?? 0}%</span></div>
  <div class="row"><span>Farmable space</span><span>${d.farmable_space_percentage ?? 0}%</span></div>
</div>
${crop && crop.primary_crop ? `
<div class="section">
  <h2 style="font-size:1.1rem;">Top crop suggestion</h2>
  <div class="crop">
    <strong>${crop.primary_crop.emoji || '🌱'} ${crop.primary_crop.name}</strong> — ${crop.primary_crop.match_pct || 0}% match<br>
    <small>${crop.primary_crop.description || ''}</small>
  </div>
  <p><small>${crop.summary || ''}</small></p>
</div>` : ''}
<p class="section" style="font-size:0.85rem;color:#64748b;">AGNI – Adaptive Geo-secured Network for Intelligent Agriculture. Report generated from image analysis and crop recommendation engine.</p>
</body></html>`;
      const w = window.open('', '_blank');
      w.document.write(html);
      w.document.close();
      w.focus();
      setTimeout(() => w.print(), 300);
    });

    // Tooltip functionality
    document.addEventListener('click', (e) => {
      if (e.target.closest('.info-tooltip-btn')) {
        const btn = e.target.closest('.info-tooltip-btn');
        const tooltip = btn.getAttribute('data-tooltip');
        if (tooltip) alert(tooltip);
      }
    });

    // Profile save
    document.getElementById('saveProfileBtn').addEventListener('click', () => {
      alert('Profile saved! (This is a demo - data is stored locally)');
      localStorage.setItem('profile_email', document.getElementById('profileEmail').value);
      localStorage.setItem('profile_farm', document.getElementById('profileFarmName').value);
      localStorage.setItem('profile_location', document.getElementById('profileLocation').value);
    });

    // Load saved profile
    if (localStorage.getItem('profile_email')) {
      document.getElementById('profileEmail').value = localStorage.getItem('profile_email');
      document.getElementById('profileFarmName').value = localStorage.getItem('profile_farm') || '';
      document.getElementById('profileLocation').value = localStorage.getItem('profile_location') || '';
    }

    // Initialize
    if (token && username) {
      showApp();
    } else {
      showLogin();
    }

    // Health check
    async function checkHealth() {
      try {
        const res = await fetch(API_BASE + '/health');
        const data = await res.json().catch(() => ({}));
        if (data.status === 'active') {
          document.getElementById('statusText').textContent = 'System Active';
        }
      } catch (_) {
        document.getElementById('statusText').textContent = 'System Offline';
      }
    }
    checkHealth();
    setInterval(checkHealth, 30000);

    // ===== LAND USE BREAKDOWN =====
    function displayLandUseBreakdown(data) {
      const section = document.getElementById('landUseBreakdown');
      if (!section) return;
      section.classList.remove('hidden');
      const fields = [
        { id: 'Vegetation', value: data.vegetation_percentage ?? 0 },
        { id: 'Water', value: data.water_percentage ?? 0 },
        { id: 'Roads', value: data.road_percentage ?? 0 },
        { id: 'Buildings', value: data.building_percentage ?? 0 },
        { id: 'Farmable', value: data.farmable_space_percentage ?? 0 },
      ];
      fields.forEach(f => {
        const val = Number.isFinite(f.value) ? f.value : parseFloat(f.value) || 0;
        const bar = document.getElementById('bar' + f.id);
        const pct = document.getElementById('pct' + f.id);
        if (bar) {
          const clamped = Math.max(0, Math.min(val, 100));
          const widthPct = clamped;
          bar.style.width = widthPct + '%';
          bar.style.minWidth = (clamped > 0 && clamped < 1) ? '2%' : '0';
        }
        if (pct) pct.textContent = val.toFixed(1) + '%';
      });
    }

    // ===== CROP RECOMMENDATION SYSTEM =====
    // Store last analysis data for crop recommendations and AI Suggestion tab
    let lastAnalysisData = null;
    let lastPlotLat = null;
    let lastPlotLon = null;
    let lastJudgeSummary = null;
    let lastJudgeSummarySub = null;
    let lastCropData = null;
    let lastPlotSuggestionData = null;

    async function fetchWeatherAndRecommendCrops(analysisData) {
      lastAnalysisData = analysisData;
      const section = document.getElementById('cropRecommendationsSection');
      const loading = document.getElementById('cropLoading');
      section.classList.remove('hidden');
      loading.classList.remove('hidden');
      document.getElementById('cropPrimarySection').classList.add('hidden');
      document.getElementById('cropHighlyRecommended').classList.add('hidden');
      document.getElementById('cropModeratelySuitable').classList.add('hidden');
      document.getElementById('cropFooter').classList.add('hidden');

      // Get coordinates from map center or boundary center
      let lat = 20.5937, lon = 78.9629; // Default: India center
      if (confirmedBoundaryCoords && confirmedBoundaryCoords.length >= 3) {
        lat = confirmedBoundaryCoords.reduce((s, c) => s + c[0], 0) / confirmedBoundaryCoords.length;
        lon = confirmedBoundaryCoords.reduce((s, c) => s + c[1], 0) / confirmedBoundaryCoords.length;
      } else if (selectedLocationData && selectedLocationData.lat != null && selectedLocationData.lon != null) {
        lat = selectedLocationData.lat;
        lon = selectedLocationData.lon;
      } else if (farmMap) {
        const center = farmMap.getCenter();
        lat = center.lat;
        lon = center.lng;
      }
      lastPlotLat = lat;
      lastPlotLon = lon;

      try {
        // Step 1: Fetch weather by coordinates
        const weatherRes = await fetch(
          `${API_BASE}/weather-by-coords?lat=${lat}&lon=${lon}`,
          { headers: { 'Authorization': 'Bearer ' + token } }
        );
        if (weatherRes.status === 401) { showLogin(); return; }
        const weatherData = await weatherRes.json();

        if (!weatherData.success) {
          throw new Error('Weather API failed');
        }

        const temp = weatherData.temp;
        const humidity = weatherData.humidity;
        const locationName = weatherData.name + (weatherData.country ? ', ' + weatherData.country : '');

        // Step 2: Fetch crop recommendations
        const cropRes = await fetch(
          `${API_BASE}/recommend-crops?temp=${temp}&humidity=${humidity}&lat=${lat}` +
          `&cultivated_pct=${analysisData.cultivated_percentage || 0}` +
          `&water_pct=${analysisData.water_percentage || 0}` +
          `&farmable_space_pct=${analysisData.farmable_space_percentage || 50}`,
          { headers: { 'Authorization': 'Bearer ' + token } }
        );
        if (cropRes.status === 401) { showLogin(); return; }
        const cropData = await cropRes.json();

        if (!cropData.success) {
          throw new Error('Crop recommendation failed');
        }

        // Display results
        loading.classList.add('hidden');
        displayCropRecommendations(cropData, temp, humidity, locationName);
        lastCropData = cropData;
        const primary = cropData.primary_crop;
        if (primary) {
          lastJudgeSummary = `Suitable for agriculture. Top pick: ${primary.name} (${primary.match_pct || 0}% match).`;
          lastJudgeSummarySub = cropData.summary || `${locationName} · ${temp}°C, ${cropData.season_display || ''}`;
        } else {
          lastJudgeSummary = cropData.summary || 'Conditions evaluated. Check crop list for options.';
          lastJudgeSummarySub = `${locationName} · ${temp}°C`;
        }
        const judgeCard = document.getElementById('judgeSummaryCard');
        if (judgeCard) {
          judgeCard.classList.remove('hidden');
          document.getElementById('judgeSummaryText').textContent = lastJudgeSummary;
          document.getElementById('judgeSummarySub').textContent = lastJudgeSummarySub;
        }

      } catch (err) {
        console.error('Crop recommendation error:', err);
        loading.classList.add('hidden');
        document.getElementById('cropSummaryText').textContent = 'Could not fetch recommendations. Check weather API key and connection.';
        document.getElementById('cropConditionsText').textContent = '';
        document.getElementById('cropSeasonBadge').textContent = '';
      }
    }

    function displayCropRecommendations(cropData, temp, humidity, locationName) {
      // Header info
      document.getElementById('cropSeasonBadge').textContent = cropData.season_display || '';
      document.getElementById('cropSummaryText').textContent = cropData.summary || '';
      document.getElementById('cropConditionsText').textContent =
        `📍 ${locationName}  |  🌡️ ${temp}°C  |  💧 ${humidity}%  |  🌱 ${cropData.available_space_pct}% space available  |  💦 ${cropData.water_detected_pct}% water detected`;

      const primarySection = document.getElementById('cropPrimarySection');
      const highSection = document.getElementById('cropHighlyRecommended');
      const modSection = document.getElementById('cropModeratelySuitable');

      // One primary + sub-suggestions
      if (cropData.primary_crop) {
        primarySection.classList.remove('hidden');
        highSection.classList.add('hidden');
        modSection.classList.add('hidden');
        document.getElementById('cropPrimaryCard').innerHTML = renderPrimaryCropCard(cropData.primary_crop);
        document.getElementById('cropSubSuggestions').innerHTML =
          (cropData.sub_suggestions || []).map(c => renderSubCropItem(c)).join('');
      } else {
        primarySection.classList.add('hidden');
        const highList = document.getElementById('cropHighList');
        if (cropData.highly_recommended && cropData.highly_recommended.length > 0) {
          highSection.classList.remove('hidden');
          highList.innerHTML = cropData.highly_recommended.map(c => renderCropCard(c, 'high')).join('');
        } else {
          highSection.classList.add('hidden');
        }
        const modList = document.getElementById('cropModList');
        if (cropData.moderately_suitable && cropData.moderately_suitable.length > 0) {
          modSection.classList.remove('hidden');
          document.getElementById('modCropCount').textContent = cropData.moderately_suitable.length;
          modList.innerHTML = cropData.moderately_suitable.map(c => renderCropCard(c, 'mod')).join('');
        } else {
          modSection.classList.add('hidden');
        }
      }

      const footer = document.getElementById('cropFooter');
      footer.classList.remove('hidden');
      document.getElementById('cropEvalSummary').textContent =
        `Evaluated ${cropData.total_crops_evaluated} crops. ${cropData.not_recommended_count} not suitable for current conditions.`;
    }

    function renderPrimaryCropCard(crop) {
      const scorePct = crop.match_pct || 0;
      const barColor = scorePct >= 80 ? 'bg-emerald-500' : scorePct >= 60 ? 'bg-teal-500' : 'bg-amber-500';
      const reasonsHtml = (crop.reasons || []).slice(0, 3).map(r =>
        `<span class="inline-flex items-center gap-1 text-xs text-emerald-700 bg-emerald-50 px-2 py-1 rounded-full"><i class="fas fa-check text-emerald-500" style="font-size:8px"></i>${r}</span>`
      ).join('');
      const waterIcons = { low: '💧', medium: '💧💧', high: '💧💧💧' };
      return `
        <div class="crop-card bg-white rounded-xl border-2 border-emerald-200 p-5 shadow-md">
          <div class="flex items-start justify-between mb-3">
            <div class="flex items-center gap-3">
              <span class="text-4xl">${crop.emoji}</span>
              <div>
                <h6 class="font-bold text-slate-800 text-lg leading-tight">${crop.name}</h6>
                <span class="text-sm text-slate-500">${crop.category} · ${crop.duration}</span>
              </div>
            </div>
            <span class="text-sm font-bold text-emerald-700 bg-emerald-50 px-3 py-1 rounded-full border border-emerald-200">${scorePct}% match</span>
          </div>
          <p class="text-sm text-slate-600 mb-3">${crop.description}</p>
          <div class="flex flex-wrap gap-2 mb-3">
            <span class="text-xs text-slate-500">🌡️ ${crop.temp_range}</span>
            <span class="text-xs text-slate-500">${waterIcons[crop.water_need] || '💧'} ${(crop.water_need || '').toLowerCase()}</span>
          </div>
          <div class="flex flex-wrap gap-2">${reasonsHtml}</div>
        </div>
      `;
    }

    function renderSubCropItem(crop) {
      const scorePct = crop.match_pct || 0;
      const waterIcons = { low: '💧', medium: '💧💧', high: '💧💧💧' };
      return `
        <div class="bg-white/80 rounded-lg border border-teal-200 px-3 py-2 text-sm">
          <div class="flex items-center justify-between gap-2">
            <span class="text-lg">${crop.emoji}</span>
            <span class="font-semibold text-slate-800 truncate">${crop.name}</span>
            <span class="text-xs font-medium text-teal-700 shrink-0">${scorePct}%</span>
          </div>
          <p class="text-xs text-slate-500 mt-0.5">${crop.category} · ${crop.duration} · ${waterIcons[crop.water_need] || '💧'}</p>
        </div>
      `;
    }

    function renderCropCard(crop, tier) {
      const scorePct = crop.match_pct || 0;
      const barColor = scorePct >= 80 ? 'bg-emerald-500' : scorePct >= 60 ? 'bg-teal-500' : 'bg-amber-500';
      const borderColor = tier === 'high' ? 'border-emerald-200' : 'border-teal-200';
      const bgColor = tier === 'high' ? 'bg-white' : 'bg-white/80';
      const waterIcons = { low: '💧', medium: '💧💧', high: '💧💧💧' };

      const reasonsHtml = crop.reasons.slice(0, 2).map(r =>
        `<span class="inline-flex items-center gap-1 text-xs text-emerald-700 bg-emerald-50 px-2 py-0.5 rounded-full"><i class="fas fa-check text-emerald-500" style="font-size:8px"></i>${r}</span>`
      ).join('');

      const warningsHtml = crop.warnings.slice(0, 1).map(w =>
        `<span class="inline-flex items-center gap-1 text-xs text-amber-700 bg-amber-50 px-2 py-0.5 rounded-full"><i class="fas fa-exclamation text-amber-500" style="font-size:8px"></i>${w}</span>`
      ).join('');

      return `
        <div class="crop-card ${bgColor} rounded-lg border ${borderColor} p-4 shadow-sm">
          <div class="flex items-start justify-between mb-2">
            <div class="flex items-center gap-2">
              <span class="text-2xl">${crop.emoji}</span>
              <div>
                <h6 class="font-semibold text-slate-800 text-sm leading-tight">${crop.name}</h6>
                <span class="text-xs text-slate-500">${crop.category} · ${crop.duration}</span>
              </div>
            </div>
            <span class="text-xs font-bold ${scorePct >= 80 ? 'text-emerald-700' : scorePct >= 60 ? 'text-teal-700' : 'text-amber-700'} bg-white px-2 py-0.5 rounded-full border">
              ${scorePct}%
            </span>
          </div>
          <div class="mb-2">
            <div class="w-full bg-slate-100 rounded-full h-1.5 overflow-hidden">
              <div class="score-bar ${barColor} h-1.5 rounded-full" style="width: 0%" data-width="${scorePct}%"></div>
            </div>
          </div>
          <p class="text-xs text-slate-600 mb-2">${crop.description}</p>
          <div class="flex flex-wrap gap-1 mb-1">
            <span class="text-xs text-slate-500">🌡️${crop.temp_range}</span>
            <span class="text-xs text-slate-500">${waterIcons[crop.water_need] || '💧'}</span>
          </div>
          <div class="flex flex-wrap gap-1">
            ${reasonsHtml}
            ${warningsHtml}
          </div>
        </div>
      `;
    }

    // ===== AI SUGGESTION TAB =====
    function updateAiSuggestionLastPlotButton() {
      const btn = document.getElementById('aiSuggestionUseLastPlotBtn');
      if (!btn) return;
      btn.disabled = !lastAnalysisData;
      if (lastAnalysisData) {
        btn.title = 'Fill form with last analysis and plot location';
      } else {
        btn.title = 'Analyze an image first in Image Analyzer to use this';
      }
    }

    document.getElementById('aiSuggestionUseLastPlotBtn')?.addEventListener('click', () => {
      if (!lastAnalysisData) return;
      document.getElementById('aiSuggestionCultivatedPct').value = lastAnalysisData.cultivated_percentage ?? 50;
      document.getElementById('aiSuggestionWaterPct').value = lastAnalysisData.water_percentage ?? 5;
      document.getElementById('aiSuggestionFarmablePct').value = lastAnalysisData.farmable_space_percentage ?? 50;
      document.getElementById('aiSuggestionBuildingPct').value = lastAnalysisData.building_percentage ?? 0;
      if (lastPlotLat != null) document.getElementById('aiSuggestionLat').value = lastPlotLat;
      if (lastPlotLon != null) document.getElementById('aiSuggestionLon').value = lastPlotLon;
      document.getElementById('aiSuggestionStatus').textContent = 'Filled from last analysis. Click "Get suggestion" when ready.';
    });

    document.getElementById('aiSuggestionUseLocationBtn')?.addEventListener('click', () => {
      document.getElementById('aiSuggestionStatus').textContent = 'Getting location...';
      if (!navigator.geolocation) {
        document.getElementById('aiSuggestionStatus').textContent = 'Geolocation not supported. Enter lat/lon manually.';
        return;
      }
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          document.getElementById('aiSuggestionLat').value = pos.coords.latitude;
          document.getElementById('aiSuggestionLon').value = pos.coords.longitude;
          document.getElementById('aiSuggestionStatus').textContent = 'Location set. Adjust plot details if needed and click "Get suggestion".';
        },
        () => {
          document.getElementById('aiSuggestionStatus').textContent = 'Location denied. Enter latitude and longitude manually.';
        }
      );
    });

    document.getElementById('aiSuggestionGetBtn')?.addEventListener('click', async () => {
      const latEl = document.getElementById('aiSuggestionLat');
      const lonEl = document.getElementById('aiSuggestionLon');
      const lat = parseFloat(latEl?.value);
      const lon = parseFloat(lonEl?.value);
      if (!Number.isFinite(lat) || !Number.isFinite(lon)) {
        document.getElementById('aiSuggestionStatus').textContent = 'Please set plot location (Use current location or enter lat/lon).';
        return;
      }
      const cultivated_pct = parseFloat(document.getElementById('aiSuggestionCultivatedPct')?.value) || 50;
      const water_pct = parseFloat(document.getElementById('aiSuggestionWaterPct')?.value) || 5;
      const farmable_space_pct = parseFloat(document.getElementById('aiSuggestionFarmablePct')?.value) || 50;
      const building_pct = parseFloat(document.getElementById('aiSuggestionBuildingPct')?.value) || 0;

      document.getElementById('aiSuggestionStatus').textContent = 'Loading...';
      document.getElementById('aiSuggestionGetBtn').disabled = true;
      try {
        const url = `${API_BASE}/plot-suggestion?lat=${lat}&lon=${lon}&cultivated_pct=${cultivated_pct}&water_pct=${water_pct}&farmable_space_pct=${farmable_space_pct}&building_pct=${building_pct}`;
        const res = await fetch(url, { headers: { 'Authorization': 'Bearer ' + token } });
        if (res.status === 401) { showLogin(); return; }
        const data = await res.json();
        if (!data.success) {
          document.getElementById('aiSuggestionStatus').textContent = 'Suggestion failed.';
          return;
        }

        document.getElementById('aiSuggestionStatus').textContent = '';
        lastPlotSuggestionData = data;
        const resultDiv = document.getElementById('aiSuggestionResult');
        resultDiv.classList.remove('hidden');

        const suit = data.suitability;
        const iconEl = document.getElementById('aiSuggestionSuitabilityIcon');
        const labelEl = document.getElementById('aiSuggestionSuitabilityLabel');
        if (suit === 'suitable') {
          iconEl.className = 'fas fa-check-circle text-emerald-600';
          labelEl.textContent = 'Suitable for agriculture';
        } else if (suit === 'marginal') {
          iconEl.className = 'fas fa-exclamation-triangle text-amber-500';
          labelEl.textContent = 'Marginal — consider carefully';
        } else {
          iconEl.className = 'fas fa-times-circle text-red-500';
          labelEl.textContent = 'Not suitable for agriculture';
        }
        document.getElementById('aiSuggestionSuitabilityMessage').textContent = data.suitability_message || '';
        const bulletsEl = document.getElementById('aiSuggestionBullets');
        bulletsEl.innerHTML = (data.suggestions || []).map(s => `<li>${s}</li>`).join('');

        const weatherCard = document.getElementById('aiSuggestionWeatherCard');
        if (data.weather && data.weather.name) {
          weatherCard.classList.remove('hidden');
          document.getElementById('aiSuggestionWeatherText').textContent =
            `${data.weather.name}${data.weather.country ? ', ' + data.weather.country : ''}: ${data.weather.temp}°C, ${data.weather.humidity}% humidity — ${data.weather.weather_description || ''}`;
        } else {
          weatherCard.classList.add('hidden');
        }

        document.getElementById('aiSuggestionSeason').textContent = data.season ? `Season: ${data.season}` : '';
        const cropsList = document.getElementById('aiSuggestionCropsList');
        const topCrops = data.top_crops || (data.primary_crop ? [data.primary_crop] : []);
        cropsList.innerHTML = topCrops.slice(0, 5).map(c =>
          `<div class="flex items-center gap-2 py-1"><span class="text-xl">${c.emoji || '🌱'}</span><span class="font-medium">${c.name}</span><span class="text-sm text-slate-500">${c.match_pct || 0}% match</span></div>`
        ).join('') || '<p class="text-slate-500 text-sm">No crops matched. Try adjusting plot details or add soil info.</p>';
      } catch (err) {
        console.error(err);
        document.getElementById('aiSuggestionStatus').textContent = 'Request failed. Is the backend running?';
      } finally {
        document.getElementById('aiSuggestionGetBtn').disabled = false;
      }
    });

    document.getElementById('aiSuggestionDownloadReportBtn')?.addEventListener('click', () => {
      if (!lastPlotSuggestionData) {
        alert('Get a suggestion first to download the report.');
        return;
      }
      const d = lastPlotSuggestionData;
      const primary = d.primary_crop;
      const topCrops = d.top_crops || (primary ? [primary] : []);
      const date = new Date().toLocaleString();
      const html = `
<!DOCTYPE html>
<html><head><meta charset="utf-8"><title>AGNI – Plot Suggestion Report</title>
<style>body{font-family:system-ui,sans-serif;max-width:700px;margin:2rem auto;padding:1rem;color:#1e293b;}
h1{color:#047857;} .section{margin:1.5rem 0;} .crop{background:#f0fdf4;border:1px solid #86efac;padding:0.5rem;margin:0.25rem 0;border-radius:0.5rem;}
ul{margin:0.5rem 0;padding-left:1.25rem;}</style></head>
<body>
<h1>AGNI – Plot Suggestion Report</h1>
<p><strong>Generated:</strong> ${date}</p>
<div class="section">
  <h2>Suitability</h2>
  <p><strong>${d.suitability_message || ''}</strong></p>
  <ul>${(d.suggestions || []).map(s => `<li>${s}</li>`).join('')}</ul>
</div>
${d.weather && d.weather.name ? `<div class="section"><h2>Weather at plot</h2><p>${d.weather.name}${d.weather.country ? ', ' + d.weather.country : ''}: ${d.weather.temp}°C, ${d.weather.humidity}% — ${d.weather.weather_description || ''}</p></div>` : ''}
<div class="section">
  <h2>Top crop suggestions</h2>
  <p><small>${d.season ? 'Season: ' + d.season : ''}</small></p>
  ${topCrops.slice(0, 5).map(c => `<div class="crop"><strong>${c.emoji || '🌱'} ${c.name}</strong> — ${c.match_pct || 0}% match</div>`).join('')}
</div>
<p style="font-size:0.85rem;color:#64748b;">AGNI – Adaptive Geo-secured Network for Intelligent Agriculture.</p>
</body></html>`;
      const w = window.open('', '_blank');
      w.document.write(html);
      w.document.close();
      w.focus();
      setTimeout(() => w.print(), 300);
    });

    // Animate score bars when they appear
    function animateScoreBars() {
      document.querySelectorAll('.score-bar').forEach(bar => {
        const width = bar.getAttribute('data-width');
        if (width) {
          setTimeout(() => { bar.style.width = width; }, 100);
        }
      });
    }

    // Observer to trigger animations when crop section becomes visible
    const cropObserver = new MutationObserver(() => {
      const section = document.getElementById('cropRecommendationsSection');
      if (section && !section.classList.contains('hidden')) {
        setTimeout(animateScoreBars, 200);
      }
    });
    const cropSection = document.getElementById('cropRecommendationsSection');
    if (cropSection) {
      cropObserver.observe(cropSection, { attributes: true, attributeFilter: ['class'] });
    }

    // Toggle moderately suitable crops
    const toggleModBtn = document.getElementById('toggleModCrops');
    if (toggleModBtn) {
      toggleModBtn.addEventListener('click', () => {
        const list = document.getElementById('cropModList');
        const icon = document.getElementById('modCropToggleIcon');
        list.classList.toggle('hidden');
        icon.textContent = list.classList.contains('hidden') ? '▼' : '▲';
        if (!list.classList.contains('hidden')) {
          setTimeout(animateScoreBars, 100);
        }
      });
    }
  </script>
</body>

</html>